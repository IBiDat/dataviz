---
title: "Income inequality: Gini coefficient before and after
tax"
description: |
  A short description of the post.
categories: "2024"
author: David Pereiro Pol
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    self_contained: false
    toc: true
---

```{r}
library(tidyverse)
library(readr)
library(geomtextpath)
library(grid)
```
```{r}
replicate_values <- function(x) {
  j <- 0 # We initialize this variable here to verify the first
  # condition in the beginning of the for loop
  for (i in 1:length(x)) {
    if (!is.na(x[i]) & i >= j) {  # We check if there is a
      # NA and we put i >= j to continue in the point in which
      # the while loop ended
      j <- i + 1 # We change the value of j to start the while
      # loop in the following
      count <- 0 # To count the next 5 positions
      while (j <= length(x) && count < 5 && is.na(x[j])) { # To change
        #possible NA

        if (!is.na(x[j])) break # If there is not a NA break

        x[j] <- x[i] # Change the NA with the previous value

        j <- j + 1

        count <- count + 1
      }
    }
  }

  j <- length(x) + 1 # We do the same but bakwards
  for (i in length(x):1) {
    if (!is.na(x[i]) & i <= j) {
      j <- i - 1
      count <- 0
      while (j >= 1 && count < 5 && is.na(x[j])) {
        if (!is.na(x[j])) break
        x[j] <- x[i]
        j <- j - 1
        count <- count + 1
      }
    }
  }
  return(x)
}
```

```{r}
gini <- read_csv(file = "data/gini_data.csv")

gini

## Cleaning of names
gini <- gini |>
  rename(
    "pre_tax_gini" = paste("10.4.2 - Redistributive impact of",
    "fiscal policy, Gini index (%) - SI_DST_FISP - Prefiscal income"),
    "post_tax_gini" = paste("10.4.2 - Redistributive impact of",
     "fiscal policy, Gini index (%) - SI_DST_FISP - Postfiscal",
     "disposable income")
  ) |>
  janitor::clean_names()

gini

## Replication of data to simulate the original distribution of the data
gini_w_replicate <- gini |>
  group_by(entity) |>
  mutate(
    pre_tax_gini = replicate_values(pre_tax_gini),
    post_tax_gini = replicate_values(post_tax_gini)
  ) |>
  ungroup()  # We replicate onward and backwards the gini index
# as in the original graph

## Replicate the continent and drop NA

gini_tidy <- gini_w_replicate |>
  group_by(entity) |>
  fill(continent, .direction = "downup") |>
  ungroup() |>
  drop_na(post_tax_gini, pre_tax_gini)

# Gini 2020

gini_tidy_2020 <- gini_tidy |>
  filter(year == 2020)
```

```{r}
## Structure

p <- ggplot(gini_tidy_2020) +
  aes(x = pre_tax_gini, y = post_tax_gini)

p

p <- p +
  scale_x_continuous(limits = c(0.2,0.749),
                            minor_breaks = NULL,
                            expand = expansion(0)) +
  scale_y_continuous(limits = c(0.2, 0.660),
                     minor_breaks = NULL,
                     expand = expansion(0))
p

sysfonts::font_add_google("Playfair Display", family="playfair")
sysfonts::font_add_google("Lato", family="lato")
showtext::showtext_auto() # Since Lato is the second one it is applied
# in all texts.


p <- p + theme_minimal() +
  labs(title = paste("Income inequality: Gini coefficient",
                     "before and after tax, 2020"),
       subtitle = "Inequality is measured in terms of the
       Gini coefficient of income before taxes on the horizontal
       axis and<br>after taxes on the vertical axis",
       caption = "**Data source**: World Bank",
       tag = "OurWorldinData.org/economic-inequality  | CC BY",
       x = "Before tax",
       y = "After tax",
       size = "**Population**",
       color = NULL) +
  theme(plot.title = element_text(face = "bold",
                                  family = "playfair",
                                  size = 18,
                                  color = "#636363"),
        plot.subtitle = ggtext::element_markdown(size = 12,
                                                 color = "#636363"),
        # Markdown is used in the case of the subtitle for separating correctly
        # into two lines the subtitle
        legend.title = ggtext::element_markdown(), # For putting
        #bold and centering the text
        axis.title = element_text(size = 12,
                                  color = "#636363"),
        axis.text = element_text(size = 12,
                                 color = "#636363"),
        plot.caption = ggtext::element_markdown(size = 11,
          hjust = -0.075,
          color = "#636363"),
        plot.tag = ggtext::element_markdown(size = 11,
                                            color = "#636363"),
        plot.tag.position = c(0.79, 0.012),
        panel.grid.major = element_line(color = "#dddddd",
                                        linetype = "dashed"
                                        )
        )

p

p <- p + # Using normal abline and annotate without changing the type of
  # coordinates was very hard and the result was not as godd as using
  # this package
  geom_textabline(slope = 1, intercept = 0,
                  label = "No reduction",
                  linetype = "dashed",
                  size = 2.8,
                  hjust = 0.83,
                  color = "#a8a8a8") +
  geom_textabline(slope = 1 / 2, intercept = 0,
                  label = "Reduce by a half",
                  linetype = "dashed",
                  size = 2.8,
                  hjust = 0.75,
                  color = "#a8a8a8") +
  geom_textabline(slope = 2 / 3, intercept = 0,
              label = "Reduce by a third",
              linetype = "dashed",
              size = 2.8,
              hjust = 0.81,
              color = "#a8a8a8")

p

p <- p + geom_point(aes(size = population, color = continent),
                    alpha = 0.85, shape = 19) +
  # scale_size_area(max_size=10) +
  scale_color_manual(values = c("#a2559c", "#00847e", "#4c6a9c",
                                "#e56e5a", "#9a5129", "#883039")) +
  scale_size(range = c(1, 7.6)) # Beyond 7.7 the coloring gets worse

p

# To put the labels
gini_labels <- gini_tidy_2020 |>
  slice_sample(prop = -0.5, by = continent) # Removes randomly
# 50% of the data of each continent

p <- p +
  ggrepel::geom_text_repel(aes(label = entity,
                               color = continent),
                           segment.color = NA, # To erase the
                           # segment that links the points with the
                           # label,
                           max.overlaps = 9,
                           show.legend = FALSE,
                           data = gini_labels)
p


```



