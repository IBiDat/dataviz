---
title: "Effect of the introduction of the polio vaccine in the USA."
description: |
  A short description of the post.
categories: "2022"
author: Juan Diego Mendez
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    self_contained: false
    toc: true 
---
```{r}

library(readr)
library(tidyverse)
library(tibble)
library(ggplot2)
library(lubridate)
library(forcats)
library(scales)
library(viridis)
library(grDevices)
library(plotly)

```

## Data Source --> tycho.pitt.edu

### Acute nonparalytic poliomyelitis
  
```{r}
  
Polio  <- read_csv("tycho_20221212-145444.csv",
                    col_types = cols_only(Admin1Name = col_guess(),
                                          PeriodStartDate = col_guess(), 
                                        CountValue = col_guess()))
```
###Acute paralytic poliomyelitis


```{r}

Polio1 <- read_csv("tycho_20221215-094815.csv",
                   col_types = cols_only(Admin1Name = col_guess(),
                                         PeriodStartDate = col_guess(), 
                                         CountValue = col_guess()))
```

###Acute poliomyelitis

```{r}
Polio2 <- read_csv("tycho_20221215-095240.csv",
                   col_types = cols_only(Admin1Name = col_guess(),
                                         PeriodStartDate = col_guess(), 
                                         CountValue = col_guess()))
```

##Cleaning datasets

```{r}

Polio_clean <- Polio %>% mutate(PeriodStartDate = ymd(PeriodStartDate)) %>% 
  arrange(Admin1Name, by="name") %>%
  count(Admin1Name,lubridate::floor_date(PeriodStartDate, "year")) %>% 
  rename(State =Admin1Name, 
         Date = `lubridate::floor_date(PeriodStartDate, "year")`,
         Cases = n)

Polio_clean1 <- Polio1 %>% mutate(PeriodStartDate = ymd(PeriodStartDate)) %>% 
  arrange(Admin1Name, by="name") %>%
  count(Admin1Name,lubridate::floor_date(PeriodStartDate, "year")) %>% 
  rename(State =Admin1Name, 
         Date = `lubridate::floor_date(PeriodStartDate, "year")`,
         Cases = n)

Polio_clean2 <- Polio2 %>% mutate(PeriodStartDate = ymd(PeriodStartDate)) %>% 
  arrange(Admin1Name, by="name") %>%
  count(Admin1Name,lubridate::floor_date(PeriodStartDate, "year")) %>% 
  rename(State =Admin1Name, 
         Date = `lubridate::floor_date(PeriodStartDate, "year")`,
         Cases = n)
```

##Join Datasets

```{r}

Poliojoint <- full_join(Polio_clean2, Polio_clean1, by = c("State" = "State", "Date" ="Date"))

Poliojoint1 <- full_join(Poliojoint, Polio_clean, by = c("State" = "State", "Date" ="Date"))
```

##sum all cases

```{r}
Polio_sum <- Poliojoint1 %>%  mutate_at(c('Cases.x', 'Cases.y', "Cases"), as.numeric) %>% 
  mutate(sum_cases = rowSums(across(where(is.numeric)), na.rm=T), .keep = "unused") %>% 
  filter(Date >= '1928-01-01')

```

##Colors

```{r}

cols <- c(colorRampPalette(c("#e7f0fa", "#c9e2f6", "#95cbee", "#0099dc", "#4ab04a", "#ffd73e", "#eec73a", "#e29421", "#e29421", "#f05336","#ce472e"),bias=1)(11))

```

## Original Plot

```{r}
originalplot <- Polio_sum %>% ggplot() +
  aes(x=Date, y=fct_rev(State),fill=sum_cases)+
  geom_tile(colour="white", lwd = 0.2, linetype = 1) +
  theme_minimal()+
  scale_fill_gradientn(colours=cols,limits=c(0, 300),
                       breaks=seq(0, 300, by=50),
                       labels=c("0", "50", "100", "150", "200", "250", "300"),
                       guide=guide_colourbar(ticks=T, nbin=50,
                                             barheight=.6, label=T, 
                                             barwidth=8, ticks.colour= "grey", ticks.linewidth = 0.5))+
  scale_x_date(expand=c(0,0), breaks = (seq(ymd("1930-01-01"), ymd("1965-01-01"), by = "5 years")), date_labels = "%Y")+
  geom_segment(x=as.Date("1955-01-01"), xend=as.Date("1955-01-01"), y=0, yend=52.5, size=.9)+
  labs(x="", y="", fill="")+
  ggtitle("Polio") +
  theme(aspect.ratio = 6.5/12.5,
    legend.position= "bottom",
        legend.direction="horizontal",
        legend.text=element_text(colour="grey20"),
            plot.margin=grid::unit(c(.5,.5,1.5,.5), "cm"),
        axis.text.y=element_text(size=6, family="Helvetica", 
                                 hjust=1),
        axis.text.x=element_text(size=8),
        axis.ticks.y=element_blank(),
    axis.ticks.x=element_line(color = "grey50", size = 0.5),
    axis.line.x =element_line(color = "grey50", size = 0.5),
        panel.grid=element_blank(),
        title=element_text(hjust=-.07, face="bold", vjust=1, 
                           family="Helvetica"),
        text=element_text(family="URWHelvetica"))+
  annotate("text", x=as.Date("1955-01-01"), y=54, label="Vaccine introduced", 
           vjust=1, hjust=0, size=I(3), family="Helvetica")+
  coord_fixed()

```

## alternative plot Option 1
### States information for Plot_geo 

```{r}

data_abr <- read_csv("data.csv") %>% mutate(State = toupper(state))

```

### Including NA for every state and then converting NA into 0

```{r}

Polio_sum2 <- Polio_sum %>% pivot_wider(names_from = State, values_from = sum_cases) %>% pivot_longer(!Date,
                                           names_to = "State",
                                           values_to = "sum_cases",
                                           values_drop_na = FALSE) %>% 
  mutate(sum_cases = replace_na(sum_cases, 0)) %>% inner_join(data_abr, by.x = State, by.x = State) %>% select(Date, code, sum_cases) %>% mutate(Date = year(Date), Cases = sum_cases)

```

###Plot Opc 1 directly with plot_geo

```{r}

Arternativeplot1 <- plot_geo(Polio_sum2, 
                       locationmode = "USA-states", 
                       frame = ~Date)%>%
  add_trace(locations = ~code,
            z = ~Cases,
            zmin = 0,
            zmax = 300,
            color = ~Cases,
            colorscale = "Portland")%>%  
  layout(geo = list(scope = 'usa'),
         title = "Evolution of polio in the U.S.A. \n Introduction of the vaccine",
         font = list(family = "Helvetica"))%>% 
  colorbar(title = "Cases",
           font = "Helvetica") %>% 
  layout(annotations = list(text = "Vaccine introduced",
                     x = 0.5,
                     y = 0.1,
                     frame = 1,
                     font = list(family = "Arial", size = 12),
                     showarrow = FALSE))

```

## Plot Opc 2

### Load data for United States

```{r}
data(state)

df <- data.frame(value = rnorm(50),
                 region = state.name)
map_df <- map_data("state") %>% mutate(State = toupper(region))

```

### Merge data frames
```{r}

Polio_sum3 <- Polio_sum %>% mutate(Date = year(Date))

df <- full_join(Polio_sum3, map_df, by = "State") 

```

### Create Map using ggplot2 first and then ggplotly

```{r}

p <- ggplot(filter(df, Date == 1928)) +
  aes(x = long, y = lat, group = group, fill = sum_cases)+
  geom_polygon() +
  theme_minimal()+
  scale_fill_gradientn(colours=cols)+
  theme(legend.position= "right",
        legend.direction="vertical",
        legend.text=element_text(colour="grey20"),
        plot.margin=grid::unit(c(.5,.5,1.5,.5), "cm"),
        axis.text.y= element_blank(),
        axis.text.x= element_blank(),
        axis.ticks.y= element_blank(),
        axis.ticks.x= element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_blank(),
        panel.grid= element_blank(),
        title=element_text(hjust=-.07, face="bold", vjust=1, 
                           family="Arial"),
        text=element_text(family="Arial"))+
  labs(x = "", y = "", title = "The polio vaccine in the USA",
              fill = "Value")+
  coord_fixed()

```

### facet wrap
```{r}
p %+% df +
  facet_wrap("Date", nrow=4) 

```
### ggplotly

```{r}
plotly::ggplotly(p %+% df + aes(frame=Date), 
                 tooltip = "all",
                 dynamicTicks = FALSE,
                 layerData = 1,
                 originalData = FALSE,
                 source = "A")

```






