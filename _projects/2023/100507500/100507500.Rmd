---
title: "Post-COVID Wallet Woes: The High Cost of Living"
description: |
  COVID-19 had a major impact on the economy and effectively affected the consumption patterns of European households. 
categories: "2023"
author: Phong Duong
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    self_contained: false
    toc: true
---

# Introduction

# Collecting and Processing Data

## Loading Packages

```{r}
library(readr)
library(tidyverse)
library(ggplot2)
library(ggtext)
library(extrafont)
library(sysfonts)
library(showtext)
library(ggimage)
library(patchwork)
```

## Getting the data

```{r}
data <- read_csv("EU_data.csv.gz")
```

## Transforming data

```{r}
dataset <- data %>% 
  select(coicop, TIME_PERIOD, OBS_VALUE) %>% 
  mutate(coicop_name = case_when(
    coicop == "CP00" ~ "All-items HICP",
    coicop == "CP01" ~ "Food and non-alcoholic beverages",
    coicop == "CP02" ~ "Alcoholic beverages, tobacco and narcotics",
    coicop == "CP03" ~ "Clothing and footwear",
    coicop == "CP04" ~ "Housing, water and energy", #change to fit the graph
    coicop == "CP05" ~ "Household equipment and maintenance", #Change to fit the graph
    coicop == "CP06" ~ "Health",
    coicop == "CP07" ~ "Transport",
    coicop == "CP08" ~ "Communications",
    coicop == "CP09" ~ "Recreation and culture",
    coicop == "CP10" ~ "Education", 
    coicop == "CP11" ~ "Restaurants and hotels",
    coicop == "CP12" ~ "Miscellaneous goods and services"
    ),
    percent = OBS_VALUE / 1000 * 100) %>% 
  filter((!coicop %in% c("CP00")) & between(TIME_PERIOD, 2022, 2023)) %>% 
  select(coicop, coicop_name, TIME_PERIOD, percent)
```

# Replicating the Plot

## Building the basic elements

```{r fig.width = 7, fig.height = 8.5, preview = TRUE}
p_main <- ggplot(dataset, aes(x = percent,y = reorder(coicop_name, percent))) +
  geom_col(position = position_dodge2(reverse = TRUE), aes(fill = as.character(TIME_PERIOD)), width = 0.6) +
  #Axes and scales
  scale_x_continuous(name = NULL, limits = c(0,20), breaks = seq(0,20,5), position = "top") +
  scale_fill_manual(values = c("#ad9000", "#2a46aa"), labels = c("Jan 2022", "Jan 2023")) +
  #Theme
  theme(#Background and grid line
        panel.background = element_rect(fill = "white"),
        panel.grid.major.x = element_line(
          colour = "grey", 
          linetype = "dashed", 
          size = 0.3),
        plot.margin = margin(0,185,5,10),
        #Axes
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        #Legend 
        legend.title = element_blank(),
        legend.position = c(1.26, 0.97),
        legend.key.height = unit(0.68, "char"),
        legend.key.width = unit(1.25, "char"),
        legend.spacing.y = unit(0.3, "char")
        ) +
  guides(fill = guide_legend(byrow = TRUE)) #helps spacing elements in legend

#Y axis labels
labels <- c(
  "Food and\nnon-alcoholic\nbeverages",
  "Housing,\nwater\nand energy",
  "Transport",
  "Miscellaneous\ngoods and\nservices",
  "Restaurants\nand hotels",
  "Recreation\nand culture",
  "Household\nequipment and\nmaintenance",
  "Health",
  "Clothing\nand footwear",
  "Alcoholic\nbeverages,\ntobacco\nand narcotics",
  "Communications",
  "Education"
) %>% rev()


p_main <- p_main + scale_y_discrete(name = NULL,labels = labels) 

p_main
```

We split the original graph into 2 parts: icons and the rest. We start by building the main plot (bars, etc.). We change the y axis labels manually to match the original graph. Next we add the annotation text on the right.

```{r fig.width = 7, fig.height = 8.5, preview = TRUE}
caption_text <- "In January 2023, the largest categories of
household consumption expenditure in the
EU were: food and non-alcoholic beverages;
housing, water and energy; and transport.
Together they accounted for close to half
(47.1 %) of total expenditure. All three of these
categories were characterised by high price
increases during 2022, underlying their role in
relation to the cost-of-living crisis.\n
The COVID-19 crisis impacted not only
overall economic activity, but also household
consumption patterns. Across the EU, the share
of household expenditure on several categories
commonly related to eating and living at home
increased between January 2020 and January
2021. However, with COVID-19 restrictions
lifted, there was some evidence that household
consumption was returning to its pre-pandemic
structure. There was a rebound in the share
of expenditure for activities outside the home
between January 2022 and January 2023, most
notably an increase of 2.1 percentage points for
restaurants and hotels; there were also notable
gains for recreation and culture and for transport
(up 0.7 and 0.5 points, respectively)."

p_main <- p_main +
  labs(tag = caption_text) +
  coord_cartesian(clip = "off") +
  theme(plot.tag.position = c(1.060, 0.48),
        plot.tag = element_text(hjust = 0, 
                                size = 12,
                                colour = "grey50", 
                                lineheight = 0.9)) 
p_main
```

The basics of the main plot is done. We will adjust the details of the text now.

```{r fig.width = 7, fig.height = 8.5, preview = TRUE}
#Fonts
font_add_google("Open Sans", family="opensans")
showtext_auto()
font <- "opensans"

p_main <- p_main +
  theme(
    legend.text = element_text(vjust = 0.5, margin = margin(0,0,0,-3), face = "bold", 
                               size = 10, family = font),
    plot.tag = element_text(family = font),
    axis.text.y = element_text(margin = margin(0,0,0,-10),vjust = 0.4, 
                               family = font, size = 12, lineheight = 0.7),
    axis.text.x = element_text(family = font, size = 12)
  )

p_main
```

We now will build the second part of the plot (icons).

```{r fig.width = 7, fig.height = 8.5, preview = TRUE}
#Add images path
dataset <- dataset %>% 
  mutate(path = case_when(
    coicop == "CP01" ~ "Food@2x.png",
    coicop == "CP02" ~ "Alcoholic@2x.png",
    coicop == "CP03" ~ "Clothing@2x.png",
    coicop == "CP04" ~ "Housing@2x.png",
    coicop == "CP05" ~ "Householdequip@2x.png",
    coicop == "CP06" ~ "Health@2x.png",
    coicop == "CP07" ~ "Transport@2x.png",
    coicop == "CP08" ~ "Communications@2x.png",
    coicop == "CP09" ~ "Recreation@2x.png",
    coicop == "CP10" ~ "Education@2x.png", 
    coicop == "CP11" ~ "Restaurant@2x.png",
    coicop == "CP12" ~ "Miscellaneous@2x.png"
  ))

p_icon <- ggplot(dataset, aes(x = percent,y = reorder(coicop_name, percent))) +
  geom_image(aes(image = path, x = 0), size=.12) +
  theme(
    axis.text = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  ) + 
  labs(x = NULL, y = NULL, fill = NULL)

p_icon
```

We just created the second part of the graph. Now we merge the 2 together to create a unified graph.

```{r fig.width = 7, fig.height = 8.5, preview = TRUE, fig.showtext=TRUE}
caption_source = "Source: Eurostat (online data code: <span style = 'color:#2a46aa'>prc_hicp_inw</span>)"

p_replicated <- wrap_plots(list(p_icon, p_main), widths = c(7,18)) &
  plot_annotation(
    title = "Household<br>consumption expenditure",
    subtitle = "<span><b>Household budget structure<b></span><br>
    <span style = 'font-size: 13pt; color:#878586'>
    (%,share of total household consumption expenditure, EU, January 2022 and 2023)
    </span>",
    caption = caption_source,
    theme = theme(
      plot.margin = margin(15,50,15,15),
      plot.title = element_markdown(
        colour = "#2a46aa", 
        size = 40,  
        family = font,
        face = "bold",
        lineheight = 0.5),
      plot.subtitle = element_markdown(
        colour = "#2a46aa", size = 15,
        family = "opensans"),
    #caption / source
    plot.caption.position = "plot",
    plot.caption = element_markdown(
      hjust = 0, 
      size = 8, 
      colour = "#878586")
    )
  )
p_replicated
```

# Alternative Graph
