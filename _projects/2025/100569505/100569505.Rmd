---
title: "Calgary"
description: |
  A visualization of travel times by bike and transit in the city of Calgary.
categories: "2025"
author: Miguel Agenjo
date: 2025-11-24
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(out.width = "100%", fig.align = "center",
  fig.showtext = TRUE, fig.width = 34.375, fig.height = 34.375)
```

```{r libraries}
library(tidyverse)
library(osmdata)
library(geojsonsf) # Used function geojson_sf to convert geojson into sf
library(glossa) # Used function invert_polygon (idea didn't work)
library(sf) # Used function st_intersection
```



## Loading and plotting (checking json files)

```{r load_data}
# Loading travel times
hexagons <- geojson_sf("original_data/hexagons.geojson")

# Loading roads
all_roads_dissolved <- geojson_sf("original_data/all_roads_dissolved.geojson")

# Loading water
water <- geojson_sf("original_data/water.geojson")
```


**EXPLAIN THIS BETTER IN THE FINAL VERSION** The id range in `hexagons`, `bike_times`, and `transit_times` are the same. Since the `hexagons` dataset includes `bike_times` and `transit_times`, it is most likely an object created by: 1) dividing the map area in hexagons, 2) getting the travel times for those Hexagons, 3) joining those two databases using the id column. I might be able **I REMOVED THE EXPLANATION OF WHY I WAS TRYING TO CONVERT MULTILINESTRING INTO POLYGON** When searching how to convert a multilinestring into a polygon, I came across [this post](https://stackoverflow.com/questions/69224441/find-intersection-between-multilinestring-and-polygons-sf-r), which mentions the funcion `st_intersection()`. This made me think i can maybe get an object that is the intersection between `hexagons` and `all_roads_dissolved`. Maybe I can plot this directly (not a full hexagon layer underneath). But if that doesn't work, the background hexagons idea can still work. In the documentation for st_intersection() there are other functions that may be helpful.

```{r prepare_data}
# This took several minutes to run, so I'll save the object and
# avoid running the line again.
# hexroads_intersection <- st_intersection(all_roads_dissolved, hexagons)
# SHOULD I LEAVE IT WITHOUT SAVE/LOAD IN THE FINAL VERSION? PROBABLY
# save(hexroads_intersection, file = "hexroads_intersection.RData")
load("hexroads_intersection.RData")

# NOTE: I'm computing time_difference as time by bike minus time by transit. That means that:
# - Negative numbers = faster by bike
# - Positive numbers = faster by transit
hexroads_intersection <- hexroads_intersection |> 
  mutate(
    "time_difference" = b_travel_time - travel_time,
    "time_color" = case_when(
      time_difference <= -30 ~ "-2", # Bike 30 or more minutes faster
      time_difference <= -10 ~ "-1", # Bike 10 or more minutes faster (<30)
      time_difference < 10 ~ "0", # Between -10 and 10 (both not included)
      time_difference >= 30 ~ "2", # Transit 30 or more minutes faster 
      time_difference >= 10 ~ "1") # Transit 10 or more minutes faster (<30)
    )
```

## Plotting map

```{r plot_legendless_map}
# Just the map, without legend
calgary_legendless <- ggplot() +
  geom_sf( # We plot the roads:
    data = hexroads_intersection,
    aes(color = time_color),
    linewidth = 1.1,  # To make roads thicker
    show.legend = FALSE
  ) +
  scale_color_manual(
    values = c(
      "-2" = "#aa5312",   # bike >30 min faster
      "-1" = "#c88c47",   # bike 10–30 min faster
      "0"  = "#b7a6ac",   # similar travel time
      "1"  = "#a36f96",   # transit 10–30 min faster
      "2"  = "#6a4886"    # transit >30 min faster
    )
  ) +
  geom_sf( # We plot the water:
    data = water,
    fill = "#a6b0b9",
    color = "#a6b0b9",
    linewidth =1.1 # To make water thicker
    ) +
  theme_void()

calgary_legendless # To see it
```

## Plotting first legend

I used What The Font to guess what the font in the original plot is. It is StudioSans, not freely available. The closest one i could find in Google fonts was Noto Sans. So I'll use that one. I'll start with the "main" legend with blue dot.

In order to change line spacing see [here](https://stackoverflow.com/questions/39721772/line-height-spacing-for-text-in-ggplot)

In order to see the options for the point annotation see [this](https://ggplot2.tidyverse.org/articles/ggplot2-specs.html)

I got the coordinates for calgary tower from [OSM](https://www.openstreetmap.org/way/25719793), and finetuned manually.


```{r plot_legend1}
# We add the font:
sysfonts::font_add_google("Noto Sans", family = "noto_sans")
showtext::showtext_auto()

# We see what the bbox coordinates are and be able to adjust the annotation:
st_bbox(hexroads_intersection) # REMOVE FOR FINAL VERSION?

# And then annotate accordingly
calgary_legend1 <- calgary_legendless + 
  annotate( # The main text
    "text",
    x = -114.3130, 
    y = 50.9790,
    label = paste("This map shows the difference",
                  "in the time it takes to reach the",
                  "Calgary Tower     by bike and by",
                  "transit on a weekday morning.",
                  sep="\n"),
    hjust = 0, # Align left
    family = "noto_sans",
    size = 12.5,
    lineheight = 1.1, # Line spacing
    color = "#000000"
  ) + 
   annotate(  # The blue point in the legend
    "point",
    x = -114.2470, 
    y = 50.97490,  # LAST: + 10
    shape = 21, # Has to be one between 21 and 25 (according to documentation)
    size = 8.25,
    color = "#000000",
    stroke = 4.75,
    fill = "#69eafe"
  ) +
  annotate(  # The blue point in the map (Calgary Tower)
    "point",
    x = -114.0631, 
    y = 51.04460,
    shape = 21, # Has to be one between 21 and 25 (according to documentation)
    size = 8.25,
    color = "#000000",
    stroke = 4.75,
    fill = "#69eafe"
  )
  
calgary_legend1 # To seeit
  
  ggsave(
  "calgary_02.png",
  width = 15,
  height = 15,
  dpi = 300,
  bg = "white"
)
```

Almost perfect fit. Comparing with gimp changing opacity, it is really really close. I'm not sure I can get closer without using the same font as the original plot (which I cant). Maybe i could make the blue dot in the legend a little bit smaller, just to make it visually more similar.

## Plotting second legend

**CONTINUE FROM HERE**

```{r}

```

