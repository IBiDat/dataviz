---
title: "Changing Fortunes"
description: Financial Times Graph Replication
categories: "2025"
author: Tommaso Accornero
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    self_contained: false
    toc: true
---

```{r}
# ============================================================================
# LIBRARIES
# ============================================================================

library(tidyverse)
library(ggrepel)
library(maps)
library(sf)
library(usmap)
library(ggtext)
library(cowplot)
library(geomtextpath)
library(sysfonts)
library(showtext)

# ============================================================================
# LOAD CUSTOM FONT
# ============================================================================

sysfonts::font_add_google(name = "Open Sans", family = "open-sans")
showtext::showtext_auto()

# ============================================================================
# READ AND PREPARE THE DATA
# ============================================================================

data <- read.csv2("Clean_Median_Data.csv", sep = ";")

data <- data |> 
  mutate(
    Median_1999 = as.numeric(Median_1999),
    Median_2014 = as.numeric(Median_2014),
    change = Median_2014 - Median_1999,
    pct_change = ((Median_2014 - Median_1999) / Median_1999) * 100
  )

# Identify top 10 risers and fallers
top_risers <- data |> 
  arrange(desc(pct_change)) |> 
  head(10) |> 
  pull(X)

top_fallers <- data |> 
  arrange(desc(pct_change)) |> 
  tail(10) |> 
  pull(X)

raleigh <- data |> 
  filter(X == "Raleigh, NC")

# Add category column
data <- data |> 
  mutate(category = case_when(
    X %in% top_risers ~ "riser",
    X %in% top_fallers ~ "faller",
    X %in% raleigh ~ "Raleigh",
    TRUE ~ "other"
  ))

# Prepare data for plotting (long format)
plot_data <- data |> 
  select(X, Median_1999, Median_2014, category, pct_change) |> 
  pivot_longer(cols = c(Median_1999, Median_2014),
               names_to = "year",
               values_to = "income") |> 
  mutate(year_num = ifelse(year == "Median_1999", 1999, 2014))

# ============================================================================
# CREATE THE MAIN SLOPE CHART
# ============================================================================

main_plot <- ggplot(plot_data, aes(x = year_num, y = income, group = X)) +
  
  # Manual dotted grid lines
  annotate("segment", x = 1999, xend = 2014, y = 50, yend = 50,
           color = "gray85", linetype = "dotted", linewidth = 0.3) +
  annotate("segment", x = 1999, xend = 2014, y = 60, yend = 60,
           color = "gray85", linetype = "dotted", linewidth = 0.3) +
  annotate("segment", x = 1999, xend = 2014, y = 70, yend = 70,
           color = "gray85", linetype = "dotted", linewidth = 0.3) +
  annotate("segment", x = 1999, xend = 2014, y = 80, yend = 80,
           color = "gray85", linetype = "dotted", linewidth = 0.3) +
  annotate("segment", x = 1999, xend = 2014, y = 90, yend = 90,
           color = "gray85", linetype = "dotted", linewidth = 0.3) +
  
  # Background lines for "others"
  geom_line(data = plot_data |>  filter(category == "other"),
            color = "#F2DFCE", size = 0.6, alpha = 0.4) +
  
  # Lines for top fallers (red)
  geom_line(data = plot_data |>  filter(category == "faller"),
            color = "#9D2B4D", size = 0.6) +
  
  # Lines for top risers (blue)
  geom_line(data = plot_data |>  filter(category == "riser"),
            color = "#477FB0", size = 0.6) +
  
  # Line for Raleigh (gray)
  geom_line(data = plot_data |>  filter(category == "Raleigh"),
            color = "#757472", size = 0.6) +
  
  # POINTS "other" (bottom)
  geom_point(data = plot_data |>  filter(category == "other"),
             color = "#EAE3DD", size = 1.3, alpha = 0.6) +
  
  # POINTS fallers (on top of others)
  geom_point(data = plot_data |>  filter(category == "faller"),
             color = "#9D2B4D", size = 1.3) +
  
  # POINTS risers (on top of others)
  geom_point(data = plot_data |>  filter(category == "riser"),
             color = "#477FB0", size = 1.3) +
  
  # POINT Raleigh
  geom_point(data = plot_data %>% filter(category == "Raleigh"),
             color = "#757472", size = 1.5) +
  
  # Metropolitan cities Labels
  annotate("text", x = 2014.5, y = 90.743, label = "Midland, TX", 
           hjust = 0, size = 2.7, color = "#5d5d5c", fontface = "bold") +
  annotate("text", x = 2014.5, y = 89.5, label = "37%", 
           hjust = 0, size = 3.5, color = "#5d5d5c", fontface = "bold") +
  annotate("text", x = 2014.5, y = 80.966, label = "Barnstable Town, MA", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 76.074, label = "Burlington area, VT", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 74.5, label = "Raleigh, NC", 
           hjust = 0, size = 2.7, color = "#5d5d5c", fontface = "bold") +
  annotate("text", x = 2014.5, y = 73.5, label = "Lebanon, PA", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 66.6, label = "Grand Junction, CO", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 65.6, label = "Odessa, TX", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 64.6, label = "Lafayette, LA", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 63.6, label = "Ocean City, NJ", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 62.6, label = "Wichita Falls, TX", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 61.6, label = "New Orleans area, LA", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 60.2, label = "Michigan City Area, IN", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 59.35, label = "Jackson, MI", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 58.3, label = "Jackson, TN", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 57.38, label = "Winston-Salem, NC", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 56.45, label = "Elkhart-Goshen, IN", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 55.2, label = "Springfield, OH", 
           hjust = 0, size = 2.7, color = "#5d5d5c", fontface = "bold") +
  annotate("text", x = 2014.5, y = 53.957, label = "-27%", 
           hjust = 0, size = 3.5, color = "#5d5d5c", fontface = "bold") +
  annotate("text", x = 2014.5, y = 52.8, label = "Hickory area, NC", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 51.278, label = "Burlington, NC", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 49.2, label = "Rocky Mount, NC", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  annotate("text", x = 2014.5, y = 48.2, label = "Goldsboro, NC", 
           hjust = 0, size = 2.7, color = "#5d5d5c") +
  
  # y-axis numbers
  annotate("text", x = 2013.7, y = 90.7, label = "90", 
           hjust = 1, size = 3.2, color = "#5d5d5c") +
  annotate("text", x = 2013.7, y = 80.7, label = "80", 
           hjust = 1, size = 3.2, color = "#5d5d5c") +
  annotate("text", x = 2013.7, y = 70.7, label = "70", 
           hjust = 1, size = 3.2, color = "#5d5d5c") +
  annotate("text", x = 2013.7, y = 60.7, label = "60", 
           hjust = 1, size = 3.2, color = "#5d5d5c") +
  annotate("text", x = 2013.7, y = 50.7, label = "50", 
           hjust = 1, size = 3.2, color = "#5d5d5c") +
  
  # compact legend in upper-right corner
  annotate("segment", x = 2015, xend = 2015.8, y = 88, yend = 88, 
           color = "#477FB0", size = 0.6) +
  annotate("point", x = 2015, y = 88, color = "#477FB0", size = 1.3) +
  annotate("point", x = 2015.8, y = 88, color = "#477FB0", size = 1.3) +
  annotate("text", x = 2016, y = 88, label = "10 biggest risers", 
           hjust = 0, size = 2.5, color = "#5d5d5c") +
  
  annotate("segment", x = 2015, xend = 2015.8, y = 86.5, yend = 86.5, 
           color = "#8B0000", size = 0.8) +
  annotate("point", x = 2015, y = 86.5, color = "#8B0000", size = 1.3) +
  annotate("point", x = 2015.8, y = 86.5, color = "#8B0000", size = 1.3) +
  annotate("text", x = 2016, y = 86.5, label = "10 biggest fallers", 
           hjust = 0, size = 2.5, color = "#5d5d5c") +
  
  annotate("segment", x = 2015, xend = 2015.8, y = 85, yend = 85, 
           color = "#EAE3DD", size = 0.8) +
  annotate("point", x = 2015, y = 85, color = "#EAE3DD", size = 1.3) +
  annotate("point", x = 2015.8, y = 85, color = "#EAE3DD", size = 1.3) +
  annotate("text", x = 2016, y = 85, label = "Others", 
           hjust = 0, size = 2.5, color = "#5d5d5c") +
  
  # Scale and theme
  scale_x_continuous(breaks = c(1999, 2014), 
                     limits = c(1998.7, 2050),
                     expand = c(0, 0),
                     position = "top",
                     labels = NULL) + # To avoid labels being outside chart
  scale_y_continuous(breaks = seq(40, 100, by = 10),
                     limits = c(43, 92),
                     expand = c(0.023, 0.023)) +
  scale_color_manual(values = c("other" = "#EAE3DD", "riser" = "#477FB0",
                                "faller" = "#8B0000")) +
  
  # Titles
  labs(title = "Changing fortunes",
       subtitle = "US median adjusted household income ($'000)*",
       x = NULL,
       y = NULL) +
  
  # Theme customization
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16),
    plot.subtitle = element_text(size = 10, margin = margin(b = 5)),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.text.x.top = element_text(size = 10, face = "bold"),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    plot.margin = margin(10, 5, 5, 10)
  )

# ============================================================================
# LOAD AND FIX GEOCODED DATA FOR MAP
# ============================================================================

geocoded_data <- read.csv("geocoded_data.csv")

# Fix incorrectly geocoded metros (matched wrong cities outside US)
corrections <- tribble(
  ~X, ~lat_fix, ~lon_fix,
  "Augusta-Richmond County, GA-SC", 33.4735, -82.0105,
  "Birmingham-Hoover, AL", 33.5207, -86.8025,
  "Canton-Massillon, OH", 40.7989, -81.3784,
  "Hickory-Lenoir-Morganton, NC", 35.7331, -81.3412,
  "Manchester-Nashua, NH", 42.9956, -71.4548,
  "Naples-Immokalee-Marco Island, FL", 26.1420, -81.7948,
  "Norwich-New London, CT", 41.3557, -72.0995,
  "Olympia-Tumwater, WA", 47.0379, -122.9007,
  "Santa Cruz-Watsonville, CA", 36.9741, -122.0308,
  "Santa Maria-Santa Barbara, CA", 34.9530, -120.4357,
  "Winston-Salem, NC", 36.0999, -80.2442,
  "York-Hanover, PA", 39.9626, -76.7277
)

# Apply corrections
geocoded_data <- geocoded_data |> 
  left_join(corrections, by = "X") |> 
  mutate(
    lat = ifelse(!is.na(lat_fix), lat_fix, lat),
    lon = ifelse(!is.na(lon_fix), lon_fix, lon)
  ) |> 
  select(-lat_fix, -lon_fix)

# ============================================================================
# PREPARE MAP DATA
# ============================================================================

map_data <- geocoded_data |> 
  filter(!is.na(lat) & !is.na(lon)) |> 
  select(X, lon, lat, Median_1999, Median_2014, category, pct_change)

# Transform coordinates to usmap projection
map_data_transformed <- usmap_transform(map_data)

# ============================================================================
# CREATE US MAP
# ============================================================================

# usmap data as sf object, excluding Puerto Rico
us_states <- us_map(regions = "states", exclude = "PR")

# Convert to sf object
us_states_sf <- st_as_sf(us_states)

# Dissolve all states into one polygon (removes internal state boundaries)
us_outline <- us_states_sf |> 
  st_union() |> 
  st_sf()

# ============================================================================
# SEPARATE MAP DATA BY CATEGORY
# ============================================================================

map_other <- map_data_transformed |> filter(category == "other")
map_riser <- map_data_transformed |> filter(category == "riser")
map_faller <- map_data_transformed |> filter(category == "faller")
map_raleigh <- map_data_transformed |> filter(category == "Raleigh")

# ============================================================================
# CREATE THE MAP
# ============================================================================

us_map_plot <- ggplot() +
  geom_sf(
    data = us_outline,
    fill = "white",
    color = "#5d5d5c",
    linewidth = 0.1
  ) +
  geom_sf(data = map_other, aes(geometry = geometry),
          color = "#F2DFCE", size = 1.2, alpha = 1) +
  geom_sf(data = map_riser, aes(geometry = geometry),
          color = "#477FB0", size = 1.2) +
  geom_sf(data = map_faller, aes(geometry = geometry),
          color = "#9D2B4D", size = 1.2) +
  geom_sf(data = map_raleigh, aes(geometry = geometry),
          color = "#757472", size = 1.2) +
  theme_void() +
  theme(
    plot.background = element_blank(),
    panel.background = element_blank()
  )

# ============================================================================
# CREATE TEXT BOX
# ============================================================================

text_box <- ggplot() +
  annotate(
    "richtext",
    x = 1, y = 0.98,
    label = "The 229 (of 381) metropolitan<br>areas shown, account for <b>76%</b><br>of the total population of the<br>United States",
    hjust = 1, vjust = 1,
    size = 3.5,
    color = "#5d5d5c",
    lineheight = 1.2,
    label.color = NA,
    fill = NA
  ) +
  annotate(
    "richtext",
    x = 1, y = 0.64,
    label = "Of those 229, <b>190</b> have seen<br>their median income fall",
    hjust = 1, vjust = 1,
    size = 3.5,
    color = "#5d5d5c",
    lineheight = 1.2,
    label.color = NA,
    fill = NA
  ) +
  xlim(0, 1) +
  ylim(0, 1) +
  theme_void()
```
```{r plot, fig.width=6, fig.height=7.16, fig.showtext=TRUE}
# ============================================================================
# COMBINE EVERYTHING USING COWPLOT
# ============================================================================

final_plot <- ggdraw(main_plot) +
  
  # Add white background first
  theme(plot.background = element_rect(fill = "white", color = NA)) +
  
  # Axis labels (1999 and 2014)
  draw_label("1999", x = 0.055, y = 0.905, hjust = 0.5, size = 10, 
             fontface = "bold", color = "#5d5d5c") +
  draw_label("2014", x = 0.295, y = 0.905, hjust = 0.5, size = 10, 
             fontface = "bold", color = "#5d5d5c") +
  
  # map in top-right corner
  draw_plot(us_map_plot, x = 0.48, y = 0.52, width = 0.48, height = 0.52) +
  # text box below the map
  draw_plot(text_box, x = 0.55, y = 0.08, width = 0.42, height = 0.40) +
  
  # Arrow 1: Midland, TX (Biggest winner) - with curved text
  geom_textcurve(
    aes(x = 0.433, y = 0.868, xend = 0.707, yend = 0.747),
    label = "Biggest winner",
    curvature = -0.44,
    arrow = arrow(length = unit(0.15, "cm"), type = "open"),
    color = "#5d5d5c",
    linewidth = 0.3,
    size = 2.7,
    fontface = "italic",
    hjust = 0.05,
    vjust = -0.3
  ) +
  
  # Arrow 2: Springfield, OH (Biggest loser) - first segment with text
  geom_textcurve(
    aes(x = 0.46, y = 0.243, xend = 0.65, yend = 0.53),
    label = "Biggest loser",
    curvature = 0.2,
    arrow = arrow(length = unit(0, "cm")),
    color = "#5d5d5c",
    linewidth = 0.3,
        size = 2.7,
    fontface = "italic",
    hjust = 0.02,
    vjust = 1.5
  ) +
  # Arrow 2: Second segment without text
  geom_curve(
    aes(x = 0.65, y = 0.53, xend = 0.837, yend = 0.8135),
    curvature = -0.2,  # Negative curvature
    arrow = arrow(length = unit(0.15, "cm"), type = "open"),  # Arrow only at end
    color = "#5d5d5c",
    linewidth = 0.3
  ) +
  
  # Arrow 3: Raleigh, NC
  geom_curve(
    aes(x = 0.865, y = 0.70, xend = 0.887, yend = 0.787),
    curvature = 0.3,
    arrow = arrow(length = unit(0.15, "cm"), type = "open"),
    color = "#5d5d5c",
    linewidth = 0.3
  ) +
  # Label for Raleigh
  draw_label("Raleigh, NC", x = 0.76, y = 0.70, hjust = 0, size = 8,
             color = "#5d5d5c") +
  
  # Semi-transparent white rectangle behind footer text
draw_grob(
  grid::rectGrob(
    x = 0.03,
    y = 0.044,
    width = 0.285,
    height = 0.10,
    just = c("left", "bottom"),
    gp = grid::gpar(fill = "#F2DFCE", alpha = 0.15, col = NA)
  )
) +
  
  # Footer annotation (bottom left)
  draw_label(
    "* Scaled to 3-person household, adjusted for cost of living in the metro relative to the nation\nGraphic: Steven Bernard  Source: Pew Research Center",
    x = 0.03, 
    y = 0.067, 
    hjust = 0, 
    vjust = 0, 
    size = 7,
    color = "#888888",
    lineheight = 1.3
  )

# Display the final plot
final_plot
```


