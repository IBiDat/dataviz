---
title: "Longevity graph: improved version"
categories: "2025"
author: Gaia Leuzzi
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    self_contained: false
    toc: true
---
##Setup and Data Loading
```{r setup}
library(ggplot2)
library(forcats)
library(dplyr)
library(showtext)
library(cowplot)
library(magick)
library(grid)

font_add_google("Nunito Sans", "nunito", regular.wt = 200)
font_add_google("Nunito", "nunito_title", regular.wt = 500)
font_add_google("Nunito", "nunito_subtitle", regular.wt = 200)
font_add_google("Nunito", "nunito_bold", regular.wt = 900)
showtext_auto()

my_data <- read.csv("KIB_longevity data.csv")
```

##Data Preparation and Label Positioning
```{r data, fig.width=75, fig.height=65, fig.showtext=TRUE}
data_prep <- my_data |>
  filter(Science_strength %in% c(1, 2, 3)) |>
  mutate(
    Intervention = case_when(
      Intervention == "Quit" ~ "Quit smoking",
      Intervention == "Have a long-lived maternal grandfather" ~ "Have a long-lived maternal grandad",
      TRUE ~ Intervention
    ),
    Years = as.numeric(Years),
    Strength_Label = factor(Science_strength,
                            levels = c(1, 2, 3),
                            labels = c("Weak scientific evidence", "Moderate scientific evidence", "Strong scientific evidence"))
  ) |>
  arrange(Science_strength, Years) |>
  mutate(
    Years_Capped = if_else(Intervention == "Suffer severe mental illness", -12, Years),
    Years_Display = Years_Capped * 5,
    Intervention = reorder(Intervention, -Years) 
  )
```

##Plot Creation Function
```{r plot, fig.width=75, fig.height=65, fig.showtext=TRUE}
fill_scale <- scale_fill_gradientn(
  colors = c("#EF9A9A", "#FFCC80", "#FFF59D", "#A5D6A7", "#66BB6A"),
  limits = c(-75, 75), 
  values = scales::rescale(c(-75, -15, 0, 15, 75)),
  name = "YEARS",
  breaks = c(-75, 0, 75),
  labels = c("LOST", "0", "GAINED"),
  guide = guide_colorbar(
    title.position = "top", 
    title.hjust = 0.5, 
    barwidth = unit(35, "cm"), 
    barheight = unit(4, "cm"),
    frame.colour = NA, 
    ticks = FALSE 
  )
)

main_plot <- ggplot(data_prep, aes(y = Intervention, x = Years_Display)) +
  geom_vline(xintercept = seq(-50, 100, by = 25), color = "orange", linewidth = 1.2, alpha = 0.8) +
  geom_vline(xintercept = 0, color = "black", linewidth = 1.5) +
  geom_col(aes(fill = Years_Display), width = 0.95, color = "white", linewidth = 3) +
  geom_text(
    aes(
      x = if_else(Years_Display < 0, -2.5, 2.5),
      label = Intervention,
      hjust = if_else(Years_Display < 0, 1, 0)
    ),
    family = "nunito_bold", 
    fontface = "bold", 
    size = 21, 
    color = "black"
  ) +
  facet_wrap(~ Strength_Label, scales = "free_y", ncol = 3, strip.position = "top") +
  fill_scale + 
  scale_x_continuous(
    limits = c(-80, 110),
    breaks = seq(-50, 100, by = 25),
    labels = c("-10", "-5", "YEARS", "5", "10", "15", "20"),
    sec.axis = dup_axis()
  ) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_cartesian(clip = "off") +
  labs(
    title = "Live Long",
    subtitle = "What really extends lifespan?"
  ) +
  theme_void() +
  theme(
    text = element_text(family = "nunito_bold", face = "bold"),
    legend.position = c(0.88, 1.2), 
    legend.direction = "horizontal",
    legend.justification = "right",
    legend.title = element_text(size = 70, family = "nunito_bold", color = "black", margin = margin(b=40)),
    legend.text = element_text(size = 60, family = "nunito_bold", color = "black", margin = margin(t=20)),
    plot.title = element_text(size = 230, family = "nunito_title", face = "bold", color = "#333333", hjust = 0, margin = margin(b=80,l = 250)),
    plot.subtitle = element_text(size = 120, family = "nunito_subtitle", face = "italic", color = "black", hjust = 0, margin = margin(b=300,l = 250)),
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    panel.spacing = unit(0.5, "lines"), 
    strip.placement = "outside", 
    strip.text = element_text(size = 110, family = "nunito_bold", color = "#333333", margin = margin(b=100)), 
    axis.text.x = element_text(size = 60, face = "bold", color = "black", margin = margin(t = 20)),
    axis.text.x.top = element_text(size = 60, face = "bold", color = "black", margin = margin(b = 20)),
    plot.margin = margin(t = 100, r = 20, b = 20, l = 20)
  )

footer <- ggplot() +
  coord_cartesian(xlim = c(0, 1), ylim = c(0, 1)) +
  geom_segment(aes(x = 0.099, xend = 0.9, y = 0.56, yend = 0.56), color = "#ebdab5", linewidth = 90, lineend = "round") +
  geom_segment(aes(x = 0.1, xend = 0.9, y = 0.60, yend = 0.60), color = "#FFFDF2", linewidth = 90, lineend = "round") +
  geom_text(aes(x = 0.5, y = 0.65, label = "THE ULTIMATE LONGEVITY PROFILE"), family = "nunito_bold", fontface = "bold", size = 25, color = "black", hjust = 0.5) +
  geom_text(aes(x = 0.5, y = 0.52, label = "Married happy-go-lucky outdoors-loving sex-mad hippy party-girl in senior management with a cat"), family = "nunito_subtitle", fontface = "italic", size =20, color = "black", hjust = 0.5) +
  theme_void()

final_combined <- plot_grid(main_plot, footer, ncol = 1, rel_heights = c(1, 0.15))

options(repr.plot.width = 28, repr.plot.height = 7.5) 
final_combined
```


