---
title: "R&D investment spending. West vs East"
description: |
  This work  tries to replicate the graph exposed in the WSJ article "How the West Can Win a Global Power Struggle", available in this link (https://www.wsj.com/world/how-the-west-can-win-a-global-power-struggle-11647615557). Hence, GDP and investment in R&D is presented for a set of countries of the East and West block.
author: Luis Miguel Herrera Corrales
date: "`r Sys.Date()`"
categories: "2025"
output:
  distill::distill_article:
    self_contained: false
    toc: true
---
## Context:

This work aims to replicate a graph presented by the Wall Street Journal (WSJ),
in the year 2022. In that graph, data on Gross Domestic Product (GDP), in
trillions and Research & Development expenditure (R&D) is presented for a set 
of countries in the year 2019. Those countries are then divided into two blocks,
East and West, being the former build by data on the US, the EU, Japan and others,
while the latter is conformed by China and Russia. Data is retrieved from the
International Monetary Fund (IMF) database and the OECD database.

## Data loading and read in R. 

Data has been retrieved from the original sources the WSJ article exposed, thus 
being the IMF database for the GDP data and the OECD database for the R&D data. 
After major cleansing in Excel, data is exported in R as .csv, in order to 
perform minor changes and select countries to replicate the graph. 

In what is related with OECD database, from where data on R&D has been recovered
from the Main Science and Investigation Institute (MSTI), the database can be 
accesed in this link. (https://data-explorer.oecd.org/vis?lc=en&df[ds]=dsDisseminateFinalDMZ&df[id]=DSD_MSTI%40DF_MSTI&df[ag]=OECD.STI.STP&dq=.A.G%2BT_RS...&lom=LASTNPERIODS&lo=5&to[TIME_PERIOD]=false)

In what is related with GDP data, recovered from the IMF database based on the
World Economic Outlook (WEO), data can be accessed in this link.
(https://data.imf.org/en/datasets/IMF.RES:WEO)

Having said the previous, the first chunk exposes the loading of both databases.

```{r Database loading}
# library (readr) or
gedr_data <- readr::read_delim("gedr_data.csv", delim = NULL, 
                               show_col_types = FALSE)
gdp_data <- read.csv("gdp_data.csv", sep = ";")
```

Even after some initial cleansing of the database in Excel, it is required to
select the countries and columns of interest to graph. As long there are two 
graph that in the last step will be merged (one for GDP and other for R&D), I 
prefer to work with two separated databases rather than with one, in order 
to avoid misunderstandings. 

The second  and third chunk shows the procedure of cleaning of both databases 
and the selection of countries.

```{r Data cleaning and country selection for gdp_data}
library(tidyverse)
# 1st: I build a variable of countries selected. Note that China and China (
# People´s Republic of) refers to the same country, as they are coded different
# in both databases)

selected_countries <- c(
  "China", "Russia", "North Korea", "United States", "Japan", "Canada", 
  "Australia","Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", 
  "Czech Republic", "Denmark","Estonia", "Finland", "France", "Germany", 
  "Greece", "Hungary", "Ireland", "Italy","Latvia", "Lithuania", "Luxembourg", 
  "Malta", "Netherlands", "Poland", "Portugal","Romania", "Slovak Republic", 
  "Slovenia", "Spain", "Sweden", "China (People’s Republic of)")
# 2nd: I filter gdp_data for selected countries and variables of interest,
# among other features. I use gdp_data as a base database, and gdp_data_ as a 
# modified database.
gdp_data_ <- gdp_data |> 
  filter(Country %in% selected_countries,
         stringr::str_detect(Subject.Descriptor, "current"),# for GDP data on current prices
         stringr::str_detect(Units, "parity"),
         stringr::str_detect(Scale, "Billions"))
# 3rd: Modify gdp_data_ to convert non-numeric columns into numeric cols.
# This is specially relevant for Date columns, that are displayed in XYEAR form
# and as chr.
gdp_data_ <- gdp_data_ |>
  drop_na(all_of(paste0("X", 1990:2023))) |> 
  mutate(across(
    X1990:X2023,
    ~ as.numeric(gsub(",", "", .x))  # remove commas, convert to numeric
  )) |>
  pivot_longer(
    cols = X1990:X2023,
    names_to = "year",
    values_to = "gdp") |>
  mutate(
    year = as.integer(sub("X", "", year)))
```

The third chunk shows the cleaning and selection procedure for the R&D database.

```{r Data cleaning and country selection for gedr_data}
# 1st: I clean and select countries in gedr_data. As in the previous, I use
# gedr_data as a base dataset, and a gedr_data_ as a modified one, in order to
# prevent misunderstandings and limit error losses.
gedr_data_ <- gedr_data |> 
  dplyr::select(`Reference area`, Measure, TIME_PERIOD, OBS_VALUE) |> 
   filter(
    `Reference area` %in% selected_countries,
    str_detect(Measure, "GERD"),
    TIME_PERIOD == 2019)
```

The first part of the cleaning and selection procedure is now done. However, as
the original graph groups countries in blocks (EAST-WEST), and some other 
features (EU countries) can´t be extracted from the original databases, some 
work still needs to be done. The following chunks show the creation of the 
variable eu_countries and the group-region add in both databases.

```{r EU_countries, group and region variables add in original databases}
# 1st: I build a variable of eu_countries.
eu_countries <- c(
  "Austria","Belgium","Bulgaria","Croatia","Cyprus","Czech Republic","Denmark",
  "Estonia","Finland","France","Germany","Greece","Hungary","Ireland","Italy",
  "Latvia","Lithuania","Luxembourg","Malta","Netherlands","Poland","Portugal",
  "Romania","Slovak Republic","Slovenia","Spain","Sweden")
# 2nd: Add a group and region variables to gdp_data_
gdp_data_<- gdp_data_ |> 
  mutate(
    group = case_when(
      Country == "United States" ~ "U.S.",
      Country == "Japan" ~ "Japan",
      Country == "China" ~ "China",
      Country == "Russia" ~ "Russia",
      Country %in% eu_countries ~ "EU",
      TRUE ~ "Other"),
    region = case_when(
      group %in% c("U.S.", "Japan", "EU", "Other") ~ "WEST",
      group %in% c("China", "Russia") ~ "EAST"))
# 3rd: Replicate the process with gedr_data_
gedr_data_ <- gedr_data_ |> 
  mutate(
    group = case_when(
      `Reference area`== "United States" ~ "U.S.",
       `Reference area`== "Japan" ~ "Japan",
      `Reference area` == "China (People’s Republic of)" ~ "China",
      `Reference area` == "Russia" ~ "Russia",
      `Reference area`%in% eu_countries ~ "EU",
      TRUE ~ "Other"),
    region = case_when(
      group %in% c("U.S.", "Japan", "EU", "Other") ~ "WEST",
      group %in% c("China", "Russia") ~ "EAST"))

```

Now we are ready to start plotting our graph and try to replicate the original 
WSJ graph.

Firstly, we need to divide the whole graph into four different graphs, that in
the end will be merged. That is to say, in the whole graph there are four 
different graphs, two corresponding to GDP and two corresponding to R&D. 
Concerning the GDP graphs, the blue one represents the GDP in trillions of the 
WEST block, that is to say the US, the EU, Japan, and other countries allied, 
such as Australia. On the other hand, the gold part of the graph replicates the
GDP in trillions of the EAST block, meaning China and Russia, among others more 
difficult to know in base of the WSJ journal. It is needed to say that the gold 
part of the graph in GDP, is mirrored, so we need some prior transformations in
our edited dataset (gdp_data_) to corectly plot it. The following chunk shows
the mutation of the dataset to be able to plot the EAST block data. 

```{r EAST block data mirroring}
gdp_data_$gdp_mirror <- 
  ifelse(gdp_data_$region == "EAST",
                               -gdp_data_$gdp,
                               gdp_data_$gdp)
```

Now we are able to start plotting and replicating the graph. The following chunk
starts to replicate the GDP part of the graph with the most basic version of our 
graph. Firstly, we will display our axis to then start plotting the data.

```{r First step: ggplot + aes}
p <- 
  ggplot(
  gdp_data_,
  aes(x = year, y = gdp_mirror, fill = group))

print(p)
```

Once the code is run, we can see how our axis seem to be correct. Although they
will be latter transformed, and labels year and gdp_mirror will be eliminated in
future stages, before is needed to include some data. The following chunk 
modifies p by plotting geom_area.

```{r Second step: p + geom_area}
p <- 
  p + geom_area(color = "white", linewidth = .6)

print(p)
```

Now we can see that our data is looking more similar to the graph we want to 
replicate. However, colors are not grouped by block, labels still there and the 
axis are not still the ones as in the WSJ article. The following chunk changes 
the axis to adequate them to the WSJ reference, taking into account that the
y- axis is right-hand placed. 

```{r Third step: p + scale_x_continuous scale_y_continuous}
p <- 
  p + scale_x_continuous( # I create a vector of years to adequate it to WSJ.
    breaks = c(1990, 1995, 2000, 2005, 2010, 2015, 2020),
    labels = c("'90", "'95", "2000", "'05", "'10", "'15", "'20")) +
  
  scale_y_continuous( # This vector is needed to not have negative numbers in EAST)
    breaks = seq(-40000, 40000, 10000),
    labels = c("$40", "30", "20", "10", "0", "10", "20", "$30", "40"),
    position = "right",
    expand = c(0,0))
print(p)
```

Now we can see how our graph is increasingly being more similar to the WSJ one. 
However, colors are still different, and not grouped by block. Moreover, labels 
are not present in the original WSJ graph, and some add no information, such as
year. Hence, the following chunk orders the colors in blue and gold, and 
eliminate the labels of the axis.  

```{r Fourth step: replicate WSJ colors and eliminate labels}
p <- 
  p + scale_fill_manual(values = c(
    "U.S."   = "#94cced",
    "EU"     = "#94cced",
    "Japan"  = "#94cced",
    "Other"  = "#94cced",
    "China"  = "#e0c461",
    "Russia" = "#e0c461")) +
  
  labs(
    title = "Gross domestic product, in trillions",
    x = NULL,
    y = NULL)

print(p)
```

After this step, the replication graph seems much more similar to the WSJ
original. Now colors are the same, and axis replicate, within data, the ones of
the original graph. In what is more, the title has been added, although it needs
to be modified and placed in bold. Added to that, the group label is not present
in the original one, and add few if any information. Besides, these labels will 
be added to be plotted within the graph, so there is no utility in keeping 
it. The following chunk eliminates the group label, include the labels within 
the data, puts the title in bold and includes some theme_minimal adjustments to 
make the graph cleaner and more easily readable. 

```{r Fifth step: Group label elimination, labels and title modification}
p <- 
  p + theme_minimal(base_size = 11) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title = element_blank(),
    legend.position = "none",
    plot.margin = margin(5, 10, 5, 5),
    plot.title = element_text(size = 11, face = "bold")) +
  
  annotate("text", x = 2010, y = 26000, label = "Other", size = 2.5, color = "black") +
  annotate("text", x = 2010, y = 20000, label = "Japan", size = 2.5, color = "black") +
  annotate("text", x = 2010, y = 17000, label = "EU", size = 3, color = "black") +
  annotate("text", x = 2010, y = 8000, label = "U.S.", size = 3.5, color = "black") +
  annotate("text", x = 2020, y = 5000, label = "WEST", size = 7, color = "white",
           fontface = "bold", family = "Bale") +
  annotate("text", x = 2010, y = -1500, label = "Russia", size = 3.5, color = "black") +
  annotate("text", x = 2010, y = -10000, label = "China", size = 3.5, color = "black") +
  annotate("text", x = 2020, y = -10000, label = "EAST", size = 7, color = "white",
           fontface = "bold", family = "Bale")

print(p)
```

Now we can see we almost replicated the original graph. However, some major
differences will be noted, such as the small portion of GDP the EU has. This is
perhaps caused by differences in original dataset and our dataset. However, 
this seems a pretty accurate replication of our original graph, even taking into
account these differences. By now, we will leave this graph stored as p, and 
start building the R&D graph as p1, to then merge them with patchwork.

In what is related with R&D graph, two different graphs, one for WEST data and 
other for EAST data need to be built to then be merged. To make this process 
easier, I group gedr_data_ by group and region. This can be done in gedr_data_
but in order to not miss information I prefer to build a gedr_grouped and work
from this results. In what is more, since two graphs are going to be done,
I prefer to build a variable with colors rather than to repeat them twice. 
The following chunk replicates this process, to be able to graph the R&D part.

```{r gedr_grouped and colors variable}
gedr_grouped <- gedr_data_ |> 
  group_by(region, group) |> 
  summarise(gerd = sum(OBS_VALUE), .groups = "drop")

gedr_grouped$group <- factor(
  gedr_grouped$group, levels = c("Other", "Japan", "EU", "U.S.", "Russia", 
                                  "China"))
fill_cols <- c(
  "U.S."   = "#94cced",
  "EU"     = "#94cced",
  "Japan"  = "#94cced",
  "Other"  = "#94cced",
  "China"  = "#e0c461",
  "Russia" = "#e0c461"
)
```

Now we can filter this data to build ordered different datasets for WEST and EAST, 
with data ordered from the lowest to the highest, and labels centered. 
The following chunk does this and builds west_data and east_data.

```{r west_data and east_data building}
west_data <- filter(gedr_grouped, region == "WEST") |> 
  arrange(desc(group)) |> # to order data in descending order
  mutate(
    cumsum_gerd = cumsum(gerd), # to build the stacked bar
    label_pos = cumsum_gerd - gerd/2 # to place the labels in the center.
  )

east_data <- filter(gedr_grouped, region == "EAST") |> 
  arrange(desc(group)) |> # idem as before
  mutate(
    cumsum_gerd = cumsum(gerd), # idem as before
    label_pos = cumsum_gerd - gerd/2 # idem as before
  )
```

Now we can start plotting each graph separately. Firstly, the following chunk 
displays the initial steps for building the west part of the graph. 

```{r p_west initial steps}
p_west <- 
  ggplot(west_data, aes(x = 1, y = gerd, fill = group)) +
  geom_bar(color = "white", width = 0.8, stat = "identity")
# stat = "identity" is used to display data on the dataset as it is.
print(p_west)
```

We can see that the initial steps of the process may lead us to replicate in 
a very precise manner the original WSJ graph. However, major changes need to be 
made, as including replicating colors, place names of the countries within 
the bars, eliminate the group label, place the y-axis in the right side or 
write the title. The following chunk does all this. 

```{r p_west major changes process}
p_west <- p_west + 
  geom_text(aes(y = label_pos, label = group), 
            color = "black", size = 3) +
  scale_fill_manual(values = fill_cols) +
  scale_y_continuous(
    breaks = c(0, 10, 30, 50),
    labels = c("", "10", "30", "$50"),
    position = "right", 
    expand = c(0, 0)) +
  scale_x_continuous(limits = c(0.5, 1.5)) +
  labs(
    title = "Gross domestic expenditure\non research and development\nin 2019, trillions"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.title = element_text(size = 11, face = "bold", lineheight = 1.1),
    plot.margin = margin(5, 5, 2, 10)
  )
print(p_west)
```

Once done this, it seems that the resulting graph is a pretty accurate 
replication of the original WSJ we can repeat in the east part of the graph. 
In order to make it easier to read and faster to run, the following chunk 
imitates the process of the previous west graph at once. Note that, as they 
will be merged and the west part (the blue one) is placed at the top, when 
building the east part of the graph no title is needed.

```{r p_east building graph}
p_east <- ggplot(east_data, aes(x = 1, y = gerd, fill = group)) +
  geom_bar(color = "white", width = 0.8, stat = "identity") +
  geom_text(aes(y = label_pos, label = group), 
            color = "black", size = 3) +
  scale_y_continuous(
  breaks = c(0, 1, 3),
  labels = c("", "1", "$3"),
  position = "right",
  expand = c(0, 0)) +
  scale_x_continuous(limits = c(0.5, 1.5)) +
  scale_fill_manual(values = fill_cols) +
  theme_minimal(base_size = 11) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(2, 5, 5, 10)
  )
print(p_east)
```
Now, we can merge them with patchwork to see the result when trying to replicate
thw whole right part of the WSJ journal. The following chunk libraries 
patchwork, that needs to be priorly installed, to then merge both of them. Note
that the formula is used to place the east bars (the gold ones) below the west 
bars (the blue ones), as in the WSJ.

```{r patchwork and p_west/p_east merge}
library(patchwork)
p_gedr <- p_west / p_east + plot_layout(heights = c(.77, .33))
print(p_gedr)

```
Once we have both parts of the original graph, being the GDP part that is placed
in the left part of the graph and the R&D part that is placed in the right part
of the graph, it is possible to merge them, add a general title and the notes
placed in the original bottom part of the GDP part. The following chunk shows 
this process. 

```{r p and p_gedr merge, title and notes added}
final_graph <- p + p_gedr +
  plot_layout(widths = c(3, 1)) +
  plot_annotation(
    title = "The U.S. and its democratic, market-based allies in Europe and Asia together generate far more economic\noutput and spend much more on research and development than China, Russia and countries aligned with\nthem.",
    caption = "Note: GDP is converted from local currency to dollars at market exchange rates. Research and development spending is for\n2019, converted from local currency to dollars at purchasing power parity.\nSources: IMF (GDP); OECD (expenditure on R&D)",
    theme = theme(
      plot.title = element_text(size = 11, margin = margin(b = 10)),
      plot.caption = element_text(size = 8, hjust = 0, color = "gray40", 
                                  margin = margin(t = 10)))
  )

print(final_graph)
```

