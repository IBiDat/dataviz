---
title: "Data Visualization Final Project"
author: Anita Di Gennaro
format: html
editor: visual
---

#PART 1 - REPLICATION
## Data gathering and preprocessing
These files where gathered from the blog this plot was taken from. 
```{r}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
 
genres_time <- read_tsv("./export_data/genrecnts_time.tsv") #genres over time - not tidy data
```

The y axis in the original visualization is in percentages, so I will turn each value in the distribution of genres over time as a percentage.
```{r}
#percentages and cleaning the column names
genres_time <- genres_time |> 
  mutate(across(where(is.numeric), ~ 100 * .x / sum(.x))) |> 
  rename_with(~ str_remove(.x, "^y"), starts_with("y"))

#pivot the dataset to add more rows
genres_time <- genres_time |> 
  pivot_longer(cols = -genre,
               names_to = "year",
               values_to = "percentage") 

#turn year into a numeric variable, not character 
genres_time <- genres_time |>
  mutate(year = as.integer(year))
```

Now I need to order the data according to the latest peaks, which will be used to recreate the graph.
For my area plot to follow the peaks' order, I will create a data set with each year's peaks and their percentages. Finally, I will add 'other' as the category with the highest peak, as it is portrayed in the graph. 
```{r}
#peak year for each genre
peaks <- genres_time |>
  group_by(genre) |>
  slice_max(percentage, n = 1, with_ties = FALSE) |>
  ungroup() |>
  select(genre, peak_year = year)

#order genres by peak year and add Other at the end
peaks <- peaks |>
  mutate(peak_year = if_else(genre == "Other", 0, peak_year)) |>
  arrange(desc(peak_year))  #decreasing order

ordered_genres <- peaks$genre

#reverse the order for ggplot to rightfully plot it
genres_time <- genres_time |>
  mutate(genre = factor(genre, levels = rev(ordered_genres)))

```

## Skeleton of the final graph
To see if the data is rightly formatted, I want to create a basic and not refined version of the final stacked area chart.

```{r}
ggplot(genres_time, aes(x = year, y = percentage, fill = genre, group = genre)) +
  geom_area(position = "stack", alpha = 0.8, color = "white", size = 0.1) +  #white lines between each layer
  scale_y_continuous(
    labels = function(x) paste0(x, "%"),
    breaks = seq(0, 100, 20),
    expand = c(0, 0) 
  ) +
  scale_x_continuous(
    breaks = seq(1945, 2020, 10), #sequence of the years, jump each decade - will then need to be adjusted
    expand = c(0, 0) #extend the graph through the whole line
  ) +
  theme_void() + #remove all the default R theme features to then add the ones I want
  theme(       
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    legend.position = "none", #no legend
    plot.margin = margin(10, 10, 10, 10)
  )
```

##Smoothing the lines
To smooth the lines determining each area, I will try to directly smooth the data since smoothing the lines did not work. I first tried to adjust it through type="ridge" through ggstream but it was not as smooth as the original graph.
I then tried to apply a local polynomial regression adjusting the span to the highest possible value - I tried up to span = 0.3, but it was not working.

SPLINE FUNCTION (from R documentation): Perform cubic (or Hermite) spline interpolation of given data points, returning either a list of points obtained by the interpolation or a function performing the interpolation. 
Basically it draws a smooth curve through your the data and calculates what the percentage would be at each new point. It draws curves, which allows my graph to look smoother and more similar to the original one. 
```{r}
#create spline-interpolated smooth curves
genres_time_smooth <- genres_time |>
  group_by(genre) |>
  arrange(year) |>
  reframe(
    year_interp = seq(min(year), max(year), length.out = 200),
    percentage_interp = spline(year, percentage, xout = seq(min(year), max(year), length.out = 200))$y
  ) |>
  ungroup() |>
  #keep factor levels
  mutate(genre = factor(genre, levels = levels(genres_time$genre)))

#keep all levels within 100 even now that the data has been smoothed out
genres_time_smooth <- genres_time_smooth |>
  mutate(percentage_interp = pmin(percentage_interp, 100))

#plot with interpolated data
ggplot(genres_time_smooth, aes(x = year_interp, y = percentage_interp, fill = genre)) +
  geom_area(color = "white", size = 0.2) +
  scale_y_continuous(
    labels = function(x) paste0(x, "%"),
    breaks = seq(0, 100, 20),
    expand = c(0, 0)
  ) +
  scale_x_continuous(
    breaks = seq(1945, 2020, 5),
    expand = c(0, 0)
  ) +
  theme_void() +
  theme(
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    legend.position = "none",
    plot.margin = margin(10, 10, 10, 10))
```

## Adjusting the axis
The x axis needs to have a jump from 1945 to 1950, and from then onwards to be marked every 10 years. In order for it work, I need to manually adjust them. 
The y axis has percentages, marked every 20%.

With ggplot it is really complex to make the axis float, and I was not able to replicate it. Here I also adjusted the font, taking the needed font from Google. 

```{r}
library(showtext)
font_add_google("EB Garamond", "eb-garamond") #for title and annotations
showtext_auto() #enable it 

p <- ggplot(genres_time_smooth, aes(x = year_interp, y = percentage_interp, fill = genre)) +
  geom_area(color = "white", size = 0.1) +
  
  scale_y_continuous(
    labels = function(x) paste0(x, "%"),
    breaks = seq(0, 100, 20),
    expand = c(0, 0),
    position = "left"
  ) +
  scale_x_continuous(
    breaks = c(1945, 1950, 1960, 1970, 1980, 1990, 2000, 2010, 2020), #manually input the years 
    expand = c(0, 0)
  ) +
  coord_cartesian(ylim = c(0, 100), clip = "off") +
  
  labs(
    title = "Television Genres"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "sans"),
    panel.border = element_rect(color = "grey40", fill = NA, size = 0.4), #rectangle from the axis
    panel.grid = element_blank(), #to remove grid lines 
    #title
    plot.title = element_text(family = "eb-garamond", size = 18, face = "bold", hjust = 1, margin = margin(b = 5)),
    #text of the axis
    axis.text.x = element_text(size = 9, color = "grey40", margin = margin(t = 8)), #add space
    axis.text.y = element_text(size = 9, color = "grey40", margin = margin(r = 8)),
    axis.line = element_blank(),
    #remove default ticks
    axis.title = element_blank(),
#TICKS
    axis.ticks = element_line(color = "grey40", linewidth = 0.3),
    axis.ticks.length = unit(6, "pt"), 
    #legend
    legend.position = "none",
    #background
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),

    plot.margin = margin(15, 15, 15, 15))

#adding the 'percentage of episodes' annotation on the upper left corner
p <- p +
  annotate(
    "text", 
    x = 1945,     
    y = 103,
    label = "PERCENTAGE OF EPISODES",
    hjust = 0.5,     
    vjust = 0,      
    size = 3, 
    family = "sans",
    fontface = "plain",
    color = "grey40"
  )

p
```


## Colors
A gradient scale with a range from darkest to lightest color was created. To replicate the graph as closely as possible, the main recognizable (and biggest) layers were replicated and manually inserted through a color picker tool.
```{r}

ordered_genres <- levels(genres_time_smooth$genre) 
ordered_blue_genres <- ordered_genres[ordered_genres != "Other"]
n_blue_genres <- length(ordered_blue_genres)

# with colorPicker, the key three colors were defined - darkest, medium and lighter, plus a medium reference color
dark_blue <- "#c4dfe8"
mid_blue <- "#cee2e9" 
light_blue <- "#f7fbfc" 

#colorRampPalette automatically smooths the transition between the provided colors.
blue_function <- colorRampPalette(c(dark_blue, mid_blue, light_blue))
gradient_colors <- blue_function(n_blue_genres)

#to get the final palette, I will be adding some reference colors to specific genres to make it more precise
full_palette <- gradient_colors
names(full_palette) <- ordered_blue_genres

full_palette["Other"] <- "#f9fafc" 
full_palette[c("Animation & Comedy & Family",  
            "Sport", "Adventure & Animation & Comedy")] <- "#e8f2f4"
full_palette["Music"] <- "#e0eeef"
full_palette[c("Drama", "Talk Shows", "News", "Game Show", 
               "Crime", "Documentary")] <- "#c4dfe6" 
full_palette[c("Drama & Romance", "Comedy")] <- "#cee2e9"
full_palette[c("Reality TV", "Adult")] <- "#d4e5ec" 

p <- p + 
    scale_fill_manual(values = full_palette)

p

#ggsave("p4.jpg", width = 14, height = 9, dpi = "screen")
```


##Labels
Attempt to manually input the main labels by looking at the original graph and placing them according to their approximate position on the x and y axis. Four vectors were created (labels, x coordinates, y coordinates and size), which were then annotated. 
```{r}
#vectors test
labels <- c("Animation & Comedy & Family", "Adventure & Animation & Comedy", "Sport", "Comedy & Music", "Crime & Drama", "Action & Adventure & Family", "Drama & History", "Comedy & Family", "Family & Game Show", "Documentry & News", "Documentary & Family", "Comedy & Drama", "Music", "Family & Music", "Sci Fi", "Comedy & Family & Music", "Drama","Other", "Crime", "Fantasy", "Adult", "Reality TV", "Documentary", "Action & Comedy & Drama", "Talk Show", "News", "News & Talk Shows", "Drama & Romance", "Comedy", "Animation", "Action & Adventure & Crime", "Adventure", "Music & Talk Shows", "Animation & Comedy", "Documentary & History", "Reality & Romance", "Action & Adventure & Animation", "Adventure & Animation & Family", "Game Show", "Comedy & Music & Talk Show", "Comedy & Drama & Music", "Comedy & Drama & Mystery", "Comedy & Talk Show", "Family", "Horror", "Romance", "Western", "Documentary & Music", "Drama & Family", "Adventure & Comedy & Family", "Comedy & Crime & Drama", "Animation & Family", "Documentary & Talk Show", "Comedy & Drama & Fantasy", "Adventure & Drama & Family", "Action & Adventure & Drama", "Family & Game Show & Reality TV", "Comedy & Crime & Drama",  "Comedy & Family & Fantasy", "Adventure & Comedy & Family", "Drama & Family & Romance","Comedy & Crime & Sport", "comedy & Documentary", "Reality Tv & Talk Show", "Thrillers", "Drama & Thriller", "History", "Short", "Drama & Reality TV", "Crime & Documentary", "News & Sport & Talk Show", "Music & Reality TV", "Documentary & Reality TV", "Comedy & Romance", "Game Show & Music & Reality TV"
)

#X coordinates (year positions)
x_coord <- c(1945, 1945, 1946, 1945.5, 1945.5, 1954, 1954, 1954, 1953, 1956, 1952, 1952, 1947, 1949, 1950, 1948, 1957, 2017, 2018, 2018, 2016, 2012, 2015, 2011, 2020, 2020, 2019, 1982, 1953, 1959, 1959, 1960, 1960, 1960, 1985, 1983, 1985, 1985, 1986, 1956, 1958, 1959, 1963, 1964, 1964, 1969.5, 1958, 1969, 1972, 1972, 1974, 1976, 1978, 1980, 1982, 1984, 1986, 1988, 1992, 1993, 1993, 1994, 2003, 2003, 2003, 2019, 2019, 2017, 2017, 2017, 2015, 2009, 2008, 2008, 2004
)

#y coordinates
y_coord <- c(87, 82, 84, 78, 65, 76, 75, 73, 72, 71, 68, 66, 64, 63, 62, 58, 53, 95, 30, 31, 33, 35, 21, 38, 26, 5, 10, 30, 30, 24, 23, 22, 19, 18, 24, 22, 21, 20, 17, 40, 32, 35, 33, 31, 27, 27, 27, 31, 35, 37, 38 ,39, 38, 39, 40, 39, 38, 37, 18, 17, 16, 15, 24, 23, 22, 8, 7, 35, 34, 33, 32, 24, 26, 27, 28
)

#font sizes 
size <- c(3, 3, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3.5, 4, 3, 2, 3, 5, 4, 3, 3, 4, 4, 4, 3, 4.5, 4, 4, 4.5, 5,3, 3, 3, 3, 3, 3, 3, 3.5, 3, 4, 3, 3, 3, 4, 4, 3, 3.5, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3
)
#make it as a vector x = labels, y = coordinates and sizes and annotate it
#annotations
p <- p +
  annotate(
    "text", 
    x = x_coord,     
    y = y_coord,
    label = labels,
    hjust = 0.5,     
    vjust = 0,      
    size = size, 
   family = "eb-garamond",
    color = "black"
  )

p
#ggsave("p_annotations2.jpg", width = 14, height = 9, dpi = "screen")
```


# PART 2 - IMPROVEMENT
To improve the graph, I will create a smaller dataset grouping the main genres and try to showcase the change over the years through an animated line chart. 

## Animated line chart
Interactive line chart.  
```{r}
library(gganimate)
library(gifski)

#use a different color palette
tam_palette <- met.brewer("Tam", n = 8, type = "discrete")

#simple version of the improved chart
p3 <- ggplot(new_genres, aes(x = year, y = percentage, 
                                     group = genres, color = genres)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_color_manual(values = tam_palette, name = "Genres") +
    scale_y_continuous(
    name = "Percentage of Episodes",
    labels = function(x) paste0(x, "%"),
    breaks = seq(0, 100, 20),
    expand = c(0, 0),
    position = "left"
  ) +
  scale_x_continuous(
    name = "Year",
    breaks = seq(1950, 2020, 10),
    expand = c(0, 0)
  ) +
  coord_cartesian(ylim = c(0, 100), clip = "off") +
  labs(
    title = "The Evolution of Television Genres over the Years",
    subtitle = "Year: {frame_along}"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "sans"),
    panel.border = element_rect(color = "grey40", fill = NA, size = 0.4), #rectangle 
    panel.grid = element_blank(), #to remove grid lines 
    #title
    plot.title = element_text(family = "eb-garamond", size = 16, face = "bold", hjust = 0.5, margin = margin(b = 5)),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA))

#define the legend and axis's elements
p3 <- p3 + theme(
    legend.position = "right",
    legend.justification = "left",
    legend.title = element_text(family = "eb-garamond", face = "bold", size = 13, 
                                margin = margin(b = 8)),
    legend.text = element_text(family = "eb-garamond", size = 12, margin = margin(l = 5)),
    legend.key = element_rect(color = "white", size = 0.5),
    legend.key.size = unit(0.5, "cm"),
    legend.spacing.y = unit(0.3, "cm"),
    legend.background = element_rect(fill = "white", color = "grey80", size = 0.3),
    legend.margin = margin(10, 10, 10, 10), 
    #axis
    axis.text.x = element_text(size = 9, color = "black", margin = margin(t = 8)),
    axis.text.y = element_text(size = 9, color = "black", margin = margin(r = 8)),
    axis.ticks.x = element_line(color = "black", linewidth = 0.3),
    axis.ticks.length.x = unit(6, "pt"),
    axis.line = element_blank(),
    plot.margin = margin(15, 15, 15, 15))

#add the transition
p3 <- p3 + transition_reveal(year)

anim <- animate(p3, nframes = 200, fps = 20, width = 900, height = 600)
anim_save("p3.gif", animation = anim, width = 900, height = 600, units = "px", res = 100)
```

