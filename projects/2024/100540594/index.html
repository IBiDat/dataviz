<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
<title>Data visualization | MSc CSS: Global trade flows in 2022</title>

<meta property="description" itemprop="description" content="Using UN Comtrade trade data of 2022 to reproduce the resourcetrade.earth&#10;world map and produce an alternative network graph."/>

<link rel="canonical" href="https://csslab.uc3m.es/dataviz/projects/2024/100540594/"/>
<link rel="license" href="https://creativecommons.org/licenses/by/4.0/"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2025-01-10"/>
<meta property="article:created" itemprop="dateCreated" content="2025-01-10"/>
<meta name="article:author" content="Marvin-Julian Struckmeyer"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="Data visualization | MSc CSS: Global trade flows in 2022"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="Using UN Comtrade trade data of 2022 to reproduce the resourcetrade.earth&#10;world map and produce an alternative network graph."/>
<meta property="og:url" content="https://csslab.uc3m.es/dataviz/projects/2024/100540594/"/>
<meta property="og:image" content="https://csslab.uc3m.es/dataviz/projects/2024/100540594/100540594_files/figure-html5/unnamed-chunk-26-1.png"/>
<meta property="og:image:width" content="1248"/>
<meta property="og:image:height" content="768"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="Data visualization | MSc CSS"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="Data visualization | MSc CSS: Global trade flows in 2022"/>
<meta property="twitter:description" content="Using UN Comtrade trade data of 2022 to reproduce the resourcetrade.earth&#10;world map and produce an alternative network graph."/>
<meta property="twitter:url" content="https://csslab.uc3m.es/dataviz/projects/2024/100540594/"/>
<meta property="twitter:image" content="https://csslab.uc3m.es/dataviz/projects/2024/100540594/100540594_files/figure-html5/unnamed-chunk-26-1.png"/>
<meta property="twitter:image:width" content="1248"/>
<meta property="twitter:image:height" content="768"/>

<!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
<meta name="citation_title" content="Data visualization | MSc CSS: Global trade flows in 2022"/>
<meta name="citation_fulltext_html_url" content="https://csslab.uc3m.es/dataviz/projects/2024/100540594/"/>
<meta name="citation_fulltext_world_readable" content=""/>
<meta name="citation_online_date" content="2025/01/10"/>
<meta name="citation_publication_date" content="2025/01/10"/>
<meta name="citation_author" content="Marvin-Julian Struckmeyer"/>
<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["creative_commons","title","description","categories","author","date","output","citation_url","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["CC BY"]},{"type":"character","attributes":{},"value":["Global trade flows in 2022"]},{"type":"character","attributes":{},"value":["Using UN Comtrade trade data of 2022 to reproduce the resourcetrade.earth\nworld map and produce an alternative network graph."]},{"type":"character","attributes":{},"value":["2024"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name"]}},"value":[{"type":"character","attributes":{},"value":["Marvin-Julian Struckmeyer"]}]}]},{"type":"character","attributes":{},"value":["2025-01-10"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]}]}]},{"type":"character","attributes":{},"value":["https://csslab.uc3m.es/dataviz/projects/2024/100540594/"]},{"type":"character","attributes":{},"value":["https://csslab.uc3m.es/dataviz/projects/2024/100540594/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["100540594_files/anchor-4.2.2/anchor.min.js","100540594_files/bowser-1.9.3/bowser.min.js","100540594_files/distill-2.2.21/template.v2.js","100540594_files/figure-html5/network_plot_1-1.png","100540594_files/figure-html5/network_plot_2-1.png","100540594_files/figure-html5/network_plot_3-1.png","100540594_files/figure-html5/network-plot-1.png","100540594_files/figure-html5/unnamed-chunk-10-1.png","100540594_files/figure-html5/unnamed-chunk-11-1.png","100540594_files/figure-html5/unnamed-chunk-12-1.png","100540594_files/figure-html5/unnamed-chunk-13-1.png","100540594_files/figure-html5/unnamed-chunk-14-1.png","100540594_files/figure-html5/unnamed-chunk-15-1.png","100540594_files/figure-html5/unnamed-chunk-16-1.png","100540594_files/figure-html5/unnamed-chunk-17-1.png","100540594_files/figure-html5/unnamed-chunk-18-1.png","100540594_files/figure-html5/unnamed-chunk-25-1.png","100540594_files/figure-html5/unnamed-chunk-26-1.png","100540594_files/figure-html5/unnamed-chunk-27-1.png","100540594_files/figure-html5/unnamed-chunk-28-1.png","100540594_files/figure-html5/unnamed-chunk-29-1.png","100540594_files/figure-html5/unnamed-chunk-30-1.png","100540594_files/figure-html5/unnamed-chunk-8-1.png","100540594_files/figure-html5/unnamed-chunk-9-1.png","100540594_files/header-attrs-2.29/header-attrs.js","100540594_files/jquery-3.6.0/jquery-3.6.0.js","100540594_files/jquery-3.6.0/jquery-3.6.0.min.js","100540594_files/jquery-3.6.0/jquery-3.6.0.min.map","100540594_files/popper-2.6.0/popper.min.js","100540594_files/tippy-6.2.7/tippy-bundle.umd.min.js","100540594_files/tippy-6.2.7/tippy-light-border.css","100540594_files/tippy-6.2.7/tippy.css","100540594_files/tippy-6.2.7/tippy.umd.min.js","100540594_files/webcomponents-2.0.0/webcomponents.js","legend.png","Original_Plot.png","resourcetradeearth-all-all-all-2022.xlsx"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      tolerance: 5,
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

/* adjust viewport for navbar height */
/* helps vertically center bootstrap (non-distill) content */
.min-vh-100 {
  min-height: calc(100vh - 100px) !important;
}

</style>

<script src="../../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../../site_libs/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"/>
<link href="../../../site_libs/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"/>
<script src="../../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<script src="../../../site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
<script src="../../../site_libs/fuse-6.4.1/fuse.min.js"></script>

<script type="application/javascript">

function getMeta(metaName) {
  var metas = document.getElementsByTagName('meta');
  for (let i = 0; i < metas.length; i++) {
    if (metas[i].getAttribute('name') === metaName) {
      return metas[i].getAttribute('content');
    }
  }
  return '';
}

function offsetURL(url) {
  var offset = getMeta('distill:offset');
  return offset ? offset + '/' + url : url;
}

function createFuseIndex() {

  // create fuse index
  var options = {
    keys: [
      { name: 'title', weight: 20 },
      { name: 'categories', weight: 15 },
      { name: 'description', weight: 10 },
      { name: 'contents', weight: 5 },
    ],
    ignoreLocation: true,
    threshold: 0
  };
  var fuse = new window.Fuse([], options);

  // fetch the main search.json
  return fetch(offsetURL('search.json'))
    .then(function(response) {
      if (response.status == 200) {
        return response.json().then(function(json) {
          // index main articles
          json.articles.forEach(function(article) {
            fuse.add(article);
          });
          // download collections and index their articles
          return Promise.all(json.collections.map(function(collection) {
            return fetch(offsetURL(collection)).then(function(response) {
              if (response.status === 200) {
                return response.json().then(function(articles) {
                  articles.forEach(function(article) {
                    fuse.add(article);
                  });
                })
              } else {
                return Promise.reject(
                  new Error('Unexpected status from search index request: ' +
                            response.status)
                );
              }
            });
          })).then(function() {
            return fuse;
          });
        });

      } else {
        return Promise.reject(
          new Error('Unexpected status from search index request: ' +
                      response.status)
        );
      }
    });
}

window.document.addEventListener("DOMContentLoaded", function (event) {

  // get search element (bail if we don't have one)
  var searchEl = window.document.getElementById('distill-search');
  if (!searchEl)
    return;

  createFuseIndex()
    .then(function(fuse) {

      // make search box visible
      searchEl.classList.remove('hidden');

      // initialize autocomplete
      var options = {
        autoselect: true,
        hint: false,
        minLength: 2,
      };
      window.autocomplete(searchEl, options, [{
        source: function(query, callback) {
          const searchOptions = {
            isCaseSensitive: false,
            shouldSort: true,
            minMatchCharLength: 2,
            limit: 10,
          };
          var results = fuse.search(query, searchOptions);
          callback(results
            .map(function(result) { return result.item; })
          );
        },
        templates: {
          suggestion: function(suggestion) {
            var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
              ? `<img src="${offsetURL(suggestion.preview)}"</img>`
              : '';
            var html = `
              <div class="search-item">
                <h3>${suggestion.title}</h3>
                <div class="search-item-description">
                  ${suggestion.description || ''}
                </div>
                <div class="search-item-preview">
                  ${img}
                </div>
              </div>
            `;
            return html;
          }
        }
      }]).on('autocomplete:selected', function(event, suggestion) {
        window.location.href = offsetURL(suggestion.path);
      });
      // remove inline display style on autocompleter (we want to
      // manage responsive display via css)
      $('.algolia-autocomplete').css("display", "");
    })
    .catch(function(error) {
      console.log(error);
    });

});

</script>

<style type="text/css">

.nav-search {
  font-size: x-small;
}

/* Algolioa Autocomplete */

.algolia-autocomplete {
  display: inline-block;
  margin-left: 10px;
  vertical-align: sub;
  background-color: white;
  color: black;
  padding: 6px;
  padding-top: 8px;
  padding-bottom: 0;
  border-radius: 6px;
  border: 1px #0F2E3D solid;
  width: 180px;
}


@media screen and (max-width: 768px) {
  .distill-site-nav .algolia-autocomplete {
    display: none;
    visibility: hidden;
  }
  .distill-site-nav.responsive .algolia-autocomplete {
    display: inline-block;
    visibility: visible;
  }
  .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
    margin-left: 0;
    width: 400px;
    max-height: 400px;
  }
}

.algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
  width: 90%;
  outline: none;
  border: none;
}

.algolia-autocomplete .aa-hint {
  color: #999;
}
.algolia-autocomplete .aa-dropdown-menu {
  width: 550px;
  max-height: 70vh;
  overflow-x: visible;
  overflow-y: scroll;
  padding: 5px;
  margin-top: 3px;
  margin-left: -150px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #999;
  border-top: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
  cursor: pointer;
  padding: 5px 4px;
  border-bottom: 1px solid #eee;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
  border-bottom: none;
  margin-bottom: 2px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
  overflow: hidden;
  font-size: 0.8em;
  line-height: 1.4em;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
  font-size: 1rem;
  margin-block-start: 0;
  margin-block-end: 5px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
  display: inline-block;
  overflow: hidden;
  height: 2.8em;
  width: 80%;
  margin-right: 4%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
  display: inline-block;
  width: 15%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
  height: 3em;
  width: auto;
  display: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
  display: initial;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
  background-color: #eee;
}
.algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
  font-weight: bold;
  font-style: normal;
}

</style>


<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
  font-size: 100%;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

hr.section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  margin: 0px;
}


d-byline {
  border-top: none;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
  border-top: none;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: auto;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

d-article details {
  grid-column: text;
  margin-bottom: 0.8em;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

/* tweak for Pandoc numbered line within distill */
d-article pre.numberSource code > span {
    left: -2em;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}

/* Citation hover box */

.tippy-box[data-theme~=light-border] {
  background-color: rgba(250, 250, 250, 0.95);
}

.tippy-content > p {
  margin-bottom: 0;
  padding: 2px;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // separator
  var separator = '<hr class="section-separator" style="clear: both"/>';
  // prepend separator above appendix
  $('.d-byline').before(separator);
  $('.d-article').before(separator);

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('details, div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme, except when numbering line
  // in code chunk
  $('pre:not(.numberLines) code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      var author_name = front_matter.authors[i].author
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', author_name ? 'ORCID ID for ' + author_name : 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // hoverable references
    $('span.citation[data-cites]').each(function() {
      const citeChild = $(this).children()[0]
      // Do not process if @xyz has been used without escaping and without bibliography activated
      // https://github.com/rstudio/distill/issues/466
      if (citeChild === undefined) return true

      if (citeChild.nodeName == "D-FOOTNOTE") {
        var fn = citeChild
        $(this).html(fn.shadowRoot.querySelector("sup"))
        $(this).id = fn.id
        fn.remove()
      }
      var refs = $(this).attr('data-cites').split(" ");
      var refHtml = refs.map(function(ref) {
        // Could use CSS.escape too here, we insure backward compatibility in navigator
        return "<p>" + $('div[id="ref-' + ref + '"]').html() + "</p>";
      }).join("\n");
      window.tippy(this, {
        allowHTML: true,
        content: refHtml,
        maxWidth: 500,
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start'
      });
    });

    // fix footnotes in tables (#411)
    // replacing broken distill.pub feature
    $('table d-footnote').each(function() {
      // we replace internal showAtNode methode which is triggered when hovering a footnote
      this.hoverBox.showAtNode = function(node) {
        // ported from https://github.com/distillpub/template/pull/105/files
        calcOffset = function(elem) {
            let x = elem.offsetLeft;
            let y = elem.offsetTop;
            // Traverse upwards until an `absolute` element is found or `elem`
            // becomes null.
            while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                x += elem.offsetLeft;
                y += elem.offsetTop;
            }

            return { left: x, top: y };
        }
        // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
        const bbox = node.getBoundingClientRect();
        const offset = calcOffset(node);
        this.show([offset.left + bbox.width, offset.top + bbox.height]);
      }
    })

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    // ignore leaflet img layers (#106)
    figures = figures.filter(':not(img[class*="leaflet"])')
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<style type="text/css">
/* base variables */

/* Edit the CSS properties in this file to create a custom
   Distill theme. Only edit values in the right column
   for each row; values shown are the CSS defaults.
   To return any property to the default,
   you may set its value to: unset
   All rows must end with a semi-colon.                      */

/* Optional: embed custom fonts here with `@import`          */
/* This must remain at the top of this file.                 */



html {
  /*-- Main font sizes --*/
  --title-size:      50px;
  --body-size:       1.06rem;
  --code-size:       14px;
  --aside-size:      12px;
  --fig-cap-size:    13px;
  /*-- Main font colors --*/
  --title-color:     #000000;
  --header-color:    rgba(0, 0, 0, 0.8);
  --body-color:      rgba(0, 0, 0, 0.8);
  --aside-color:     rgba(0, 0, 0, 0.6);
  --fig-cap-color:   rgba(0, 0, 0, 0.6);
  /*-- Specify custom fonts ~~~ must be imported above   --*/
  --heading-font:    sans-serif;
  --mono-font:       monospace;
  --body-font:       sans-serif;
  --navbar-font:     sans-serif;  /* websites + blogs only */
}

/*-- ARTICLE METADATA --*/
d-byline {
  --heading-size:    0.6rem;
  --heading-color:   rgba(0, 0, 0, 0.5);
  --body-size:       0.8rem;
  --body-color:      rgba(0, 0, 0, 0.8);
}

/*-- ARTICLE TABLE OF CONTENTS --*/
.d-contents {
  --heading-size:    18px;
  --contents-size:   13px;
}

/*-- ARTICLE APPENDIX --*/
d-appendix {
  --heading-size:    15px;
  --heading-color:   rgba(0, 0, 0, 0.65);
  --text-size:       0.8em;
  --text-color:      rgba(0, 0, 0, 0.5);
}

/*-- WEBSITE HEADER + FOOTER --*/
/* These properties only apply to Distill sites and blogs  */

.distill-site-header {
  --title-size:       18px;
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #0F2E3D;
}

.distill-site-footer {
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #0F2E3D;
}

/*-- Additional custom styles --*/
/* Add any additional CSS rules below                      */
</style>
<style type="text/css">
/* base variables */

/* Edit the CSS properties in this file to create a custom
   Distill theme. Only edit values in the right column
   for each row; values shown are the CSS defaults.
   To return any property to the default,
   you may set its value to: unset
   All rows must end with a semi-colon.                      */

/* Optional: embed custom fonts here with `@import`          */
/* This must remain at the top of this file.                 */

@import url('https://fonts.googleapis.com/css2?family=Questrial');

html {
  /*-- Main font sizes --*/
  --title-size:      50px;
  --body-size:       1.06rem;
  --code-size:       14px;
  --aside-size:      12px;
  --fig-cap-size:    13px;
  /*-- Main font colors --*/
  --title-color:     #000000;
  --header-color:    rgba(0, 0, 0, 0.8);
  --body-color:      rgba(0, 0, 0, 0.8);
  --aside-color:     rgba(0, 0, 0, 0.6);
  --fig-cap-color:   rgba(0, 0, 0, 0.6);
  /*-- Specify custom fonts ~~~ must be imported above   --*/
  --heading-font:    "Questrial", sans-serif;
  --mono-font:       monospace;
  --body-font:       "Questrial", sans-serif;
  --navbar-font:     "Questrial", sans-serif;  /* websites + blogs only */
}

/*-- ARTICLE METADATA --*/
d-byline {
  --heading-size:    0.6rem;
  --heading-color:   rgba(0, 0, 0, 0.5);
  --body-size:       0.8rem;
  --body-color:      rgba(0, 0, 0, 0.8);
}

/*-- ARTICLE TABLE OF CONTENTS --*/
.d-contents {
  --heading-size:    18px;
  --contents-size:   13px;
}

/*-- ARTICLE APPENDIX --*/
d-appendix {
  --heading-size:    15px;
  --heading-color:   rgba(0, 0, 0, 0.65);
  --text-size:       0.8em;
  --text-color:      rgba(0, 0, 0, 0.5);
}

/*-- WEBSITE HEADER + FOOTER --*/
/* These properties only apply to Distill sites and blogs  */

.distill-site-header {
  --title-size:       18px;
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #000e78;
}

.distill-site-footer {
  --text-color:       rgba(255, 255, 255, 0.8);
  --text-size:        15px;
  --hover-color:      white;
  --bkgd-color:       #000e78;
}

/*-- Additional custom styles --*/
/* Add any additional CSS rules below                      */

@media screen and (min-width: 768px) {
  d-article aside {
    height: 0;
  }
  aside.slides {
    margin-left: -148px;
    height: auto;
  }
  aside.slides + h2 {
    white-space: nowrap;
  }
}

d-article li {
  margin-bottom: 0.1em;
}

.posts-list .post-preview .thumbnail {
  max-height: 300px;
  overflow: hidden;
}</style>
<style type="text/css">
/* base style */

/* FONT FAMILIES */

:root {
  --heading-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  --mono-default: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  --body-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

body,
.posts-list .post-preview p,
.posts-list .description p {
  font-family: var(--body-font), var(--body-default);
}

h1, h2, h3, h4, h5, h6,
.posts-list .post-preview h2,
.posts-list .description h2 {
  font-family: var(--heading-font), var(--heading-default);
}

d-article div.sourceCode code,
d-article pre code {
  font-family: var(--mono-font), var(--mono-default);
}


/*-- TITLE --*/
d-title h1,
.posts-list > h1 {
  color: var(--title-color, black);
}

d-title h1 {
  font-size: var(--title-size, 50px);
}

/*-- HEADERS --*/
d-article h1,
d-article h2,
d-article h3,
d-article h4,
d-article h5,
d-article h6 {
  color: var(--header-color, rgba(0, 0, 0, 0.8));
}

/*-- BODY --*/
d-article > p,  /* only text inside of <p> tags */
d-article > ul, /* lists */
d-article > ol {
  color: var(--body-color, rgba(0, 0, 0, 0.8));
  font-size: var(--body-size, 1.06rem);
}


/*-- CODE --*/
d-article div.sourceCode code,
d-article pre code {
  font-size: var(--code-size, 14px);
}

/*-- ASIDE --*/
d-article aside {
  font-size: var(--aside-size, 12px);
  color: var(--aside-color, rgba(0, 0, 0, 0.6));
}

/*-- FIGURE CAPTIONS --*/
figure .caption,
figure figcaption,
.figure .caption {
  font-size: var(--fig-cap-size, 13px);
  color: var(--fig-cap-color, rgba(0, 0, 0, 0.6));
}

/*-- METADATA --*/
d-byline h3 {
  font-size: var(--heading-size, 0.6rem);
  color: var(--heading-color, rgba(0, 0, 0, 0.5));
}

d-byline {
  font-size: var(--body-size, 0.8rem);
  color: var(--body-color, rgba(0, 0, 0, 0.8));
}

d-byline a,
d-article d-byline a {
  color: var(--body-color, rgba(0, 0, 0, 0.8));
}

/*-- TABLE OF CONTENTS --*/
.d-contents nav h3 {
  font-size: var(--heading-size, 18px);
}

.d-contents nav a {
  font-size: var(--contents-size, 13px);
}

/*-- APPENDIX --*/
d-appendix h3 {
  font-size: var(--heading-size, 15px);
  color: var(--heading-color, rgba(0, 0, 0, 0.65));
}

d-appendix {
  font-size: var(--text-size, 0.8em);
  color: var(--text-color, rgba(0, 0, 0, 0.5));
}

d-appendix d-footnote-list a.footnote-backlink {
  color: var(--text-color, rgba(0, 0, 0, 0.5));
}

/*-- WEBSITE HEADER + FOOTER --*/
.distill-site-header .title {
  font-size: var(--title-size, 18px);
  font-family: var(--navbar-font), var(--heading-default);
}

.distill-site-header a,
.nav-dropdown .nav-dropbtn {
  font-family: var(--navbar-font), var(--heading-default);
}

.nav-dropdown .nav-dropbtn {
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  font-size: var(--text-size, 15px);
}

.distill-site-header a:hover,
.nav-dropdown:hover .nav-dropbtn {
  color: var(--hover-color, white);
}

.distill-site-header {
  font-size: var(--text-size, 15px);
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  background-color: var(--bkgd-color, #0F2E3D);
}

.distill-site-footer {
  font-size: var(--text-size, 15px);
  color: var(--text-color, rgba(255, 255, 255, 0.8));
  background-color: var(--bkgd-color, #0F2E3D);
}

.distill-site-footer a:hover {
  color: var(--hover-color, white);
}</style>
<!--/radix_placeholder_distill-->
  <script src="../../../site_libs/header-attrs-2.29/header-attrs.js"></script>
  <script src="../../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="../../../site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="../../../site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="../../../site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="../../../site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="../../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Global trade flows in 2022","description":"Using UN Comtrade trade data of 2022 to reproduce the resourcetrade.earth\nworld map and produce an alternative network graph.","authors":[{"author":"Marvin-Julian Struckmeyer","authorURL":"#","affiliation":"&nbsp;","affiliationURL":"#","orcidID":""}],"publishedDate":"2025-01-10T00:00:00.000+01:00","citationText":"Struckmeyer, 2025"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<span class="logo">
<img src="../../../assets/acronimo_0.png"/>
</span>
<a href="../../../index.html" class="title">Data visualization | MSc CSS</a>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="../../../contents.html">Contents</a>
<a href="../../../tutorials.html">Tutorials</a>
<a href="../../../resources.html">Resources</a>
<a href="../../../projects.html">Projects</a>
<a href="https://github.com/IBiDat/dataviz" aria-label="Link to source">
<i class="fab fa-github" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Global trade flows in 2022</h1>

<!--radix_placeholder_categories-->
<div class="dt-tags">
  <a href="../../../projects.html#category:2024" class="dt-tag">2024</a>
</div>
<!--/radix_placeholder_categories-->
<p><p>Using UN Comtrade trade data of 2022 to reproduce the resourcetrade.earth
world map and produce an alternative network graph.</p></p>
</div>

<div class="d-byline">
  
  Marvin-Julian Struckmeyer
  
<br/>2025-01-10
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#replication" id="toc-replication">Replication</a>
<ul>
<li><a href="#preliminaries" id="toc-preliminaries">1. Preliminaries</a></li>
<li><a href="#country-labels-and-annotations" id="toc-country-labels-and-annotations">2. Country labels and annotations</a></li>
<li><a href="#trade-flows" id="toc-trade-flows">3. Trade flows</a></li>
</ul></li>
<li><a href="#alternative-visualisation" id="toc-alternative-visualisation">Alternative visualisation</a>
<ul>
<li><a href="#preliminaries-1" id="toc-preliminaries-1">1. Preliminaries</a></li>
<li><a href="#network-graphs" id="toc-network-graphs">2. Network graphs</a></li>
</ul></li>
</ul>
</nav>
</div>
<h2 id="introduction">Introduction</h2>
<p>The visualisation shown below by the <a href="https://resourcetrade.earth">resourcetrade.earth</a> initiative explores global trade flows in 2022.</p>
<figure>
<img src="Original_Plot.png" class="external" style="width:100.0%" alt="Original visualization from resourcetrade.earth" />
<figcaption aria-hidden="true">Original visualization from resourcetrade.earth</figcaption>
</figure>
<p>It shows the biggest bilateral trade trade flows in 2022, i.e., trade between
two different countries. The thickness of the curved trade flows represents trade
volume, while the gradient color scheme, the arrows and the thickness along the
flow describe the directionality of trade. For instance,
the flows start very thin at the exporting country and get progressively thicker
until they reach the importing country. The trade is in commodities, ranging from
fertilizers, oilseeds or live animals to natural gas, iron and steel or pearls.
The raw data is from the UN Comtrade data set and then re-organised and cleaned
by the team at <a href="https://resourcetrade.earth">resourcetrade.earth</a>.
The actual visualisation was made by the design agency <a href="https://applied.works/">applied.works</a>.</p>
<p>The rest of this blog post is divided in two steps. First, we will replicate the
visualisation. Then, we will produce alternative visualisations that aim to
address some of the original plot’s shortcomings.</p>
<h2 id="replication">Replication</h2>
<p>The replication process is divided in three separate steps:</p>
<ol type="1">
<li><p>Preliminaries</p></li>
<li><p>Country labels and annotations</p></li>
<li><p>Trade flows</p></li>
</ol>
<h3 id="preliminaries">1. Preliminaries</h3>
<h4 id="libraries">Libraries</h4>
<p>We will use the following libraries for the replication.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># core packages</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>  <span class='co'># includes ggplot2, dplyr, etc.</span></span>
<span></span>
<span><span class='co'># map data</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>maps</span><span class='op'>)</span>       <span class='co'># for map_data("world")</span></span>
<span></span>
<span><span class='co'># labels</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/slowkow/ggrepel'>ggrepel</a></span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># import data</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://readxl.tidyverse.org'>readxl</a></span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># font handling</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/yixuan/showtext'>showtext</a></span><span class='op'>)</span>   <span class='co'># for custom fonts</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/yixuan/sysfonts'>sysfonts</a></span><span class='op'>)</span>   <span class='co'># for font_add_google</span></span></code></pre>
</div>
</div>
<h4 id="get-the-data">Get the data</h4>
<p>The data is provided by <a href="https://resourcetrade.earth">resourcetrade.earth</a>. We simply
need to click on the Download button in the right-bottom of the plot to download
an Excel file.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>data_raw</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://readxl.tidyverse.org/reference/read_excel.html'>read_excel</a></span><span class='op'>(</span></span>
<span>  <span class='st'>"resourcetradeearth-all-all-all-2022.xlsx"</span>,</span>
<span>  sheet <span class='op'>=</span> <span class='st'>"Trades"</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h4 id="clean-the-data">Clean the data</h4>
<p>The initial dataset is extensive, containing almost 5 million observations with
many variables that are not needed for our visualization. Thus, we will clean
this dataset in two steps:</p>
<ol type="1">
<li>Filter for only 2022 trade data, as this matches the time period shown in the
original visualization</li>
<li>Select five essential variables: the ISO3 code and name for both exporting
and importing countries, and the trade volume for each country pair or flow</li>
</ol>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>data</span> <span class='op'>&lt;-</span> <span class='va'>data_raw</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># filter for only 2022 trade data</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>Year</span> <span class='op'>==</span> <span class='fl'>2022</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># select essential variables: info about exporter, importer and trade volume</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>`Exporter ISO3`</span>, <span class='va'>Exporter</span>, </span>
<span>         <span class='va'>`Importer ISO3`</span>, <span class='va'>Importer</span>,</span>
<span>         <span class='va'>`Value (1000USD)`</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='co'># finally, rename for easier handling later</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span></span>
<span>    Exporter_ISO3 <span class='op'>=</span> <span class='va'>`Exporter ISO3`</span>,</span>
<span>    Importer_ISO3 <span class='op'>=</span> <span class='va'>`Importer ISO3`</span>,</span>
<span>    Value <span class='op'>=</span> <span class='va'>`Value (1000USD)`</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>At this stage, our data is disaggregated by resource types (such as forestry
products, fossil fuels, and metals). This means that for each country pair, we
have multiple rows representing different types of traded resources. However,
the original visualization shows total trade flows between countries, summed
across all resource types. Therefore, we need to aggregate the data by summing
up all trade volumes for each country pair.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># aggregate trade by country pairs</span></span>
<span><span class='va'>data_2</span> <span class='op'>&lt;-</span> <span class='va'>data</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>Exporter_ISO3</span>, <span class='va'>Exporter</span>, <span class='va'>Importer_ISO3</span>, <span class='va'>Importer</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>Total_Value <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>Value</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>, .groups <span class='op'>=</span> <span class='st'>'drop'</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>Looking at the original visualization, we can see a note in the bottom-right
corner, indicating that it displays the 76 largest trade flows. To match
this, we will filter our dataset to keep only the 76 largest trade flows.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># filter for the 76 largest trade flows</span></span>
<span><span class='va'>data_2_filtered</span> <span class='op'>&lt;-</span> <span class='va'>data_2</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice_max</a></span><span class='op'>(</span>order_by <span class='op'>=</span> <span class='va'>Total_Value</span>, n <span class='op'>=</span> <span class='fl'>76</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>We also need to standardise some country names to make sure that the trade data
and the map data use the same names.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># create mapping for country name standardisation</span></span>
<span><span class='va'>country_name_mapping</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>  original <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>    <span class='st'>"United States"</span>, <span class='st'>"United Arab Emirates"</span>, <span class='st'>"Korea, Republic"</span>,</span>
<span>    <span class='st'>"Russian Federation"</span>, <span class='st'>"China, Hong Kong SAR"</span>, <span class='st'>"Areas, nes"</span>,</span>
<span>    <span class='st'>"Rest of America, nes"</span>, <span class='st'>"United Kingdom"</span><span class='op'>)</span>,</span>
<span>  mapped <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>    <span class='st'>"USA"</span>, <span class='st'>"UAE"</span>, <span class='st'>"South Korea"</span>, <span class='st'>"Russia"</span>, <span class='st'>"Hong Kong"</span>,</span>
<span>    <span class='st'>"Areas, nes"</span>, <span class='st'>"Rest of America, nes"</span>, <span class='st'>"UK"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># apply the standardised names to both exporters and importers</span></span>
<span><span class='va'>data_2_filtered</span> <span class='op'>&lt;-</span> <span class='va'>data_2_filtered</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># first standardise exporter names</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>country_name_mapping</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Exporter"</span> <span class='op'>=</span> <span class='st'>"original"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>Exporter <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>mapped</span><span class='op'>)</span>, <span class='va'>mapped</span>, <span class='va'>Exporter</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>mapped</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># now standardise importer names</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>country_name_mapping</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Importer"</span> <span class='op'>=</span> <span class='st'>"original"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>Importer <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>mapped</span><span class='op'>)</span>, <span class='va'>mapped</span>, <span class='va'>Importer</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>mapped</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h4 id="map-processing">Map Processing</h4>
<p>Before we create our world map, we need to establish base coordinates that we
will use both for positioning country labels and for drawing the trade flows
between countries. We will start by creating an ‘empty’ base world map
in three steps:</p>
<ol type="1">
<li>Simplify the world map by removing small islands and regions that are not
in the original plot</li>
<li>Create the two buffer zones to give the map depth</li>
<li>Apply the correct color scheme using precise hex codes</li>
</ol>
<p>We used <a href="https://www.latlong.net">latlong.net</a>, which provides precise
longitude and latitude data for geographic locations. Moreover, we used
<a href="https://imagecolorpicker.com">imagecolorpicker</a> to get the hex color
codes of the land and sea masses and the two buffer zones.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>world_map</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/map_data.html'>map_data</a></span><span class='op'>(</span><span class='st'>"world"</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># filter many of the small islands</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='op'>!</span><span class='op'>(</span><span class='va'>region</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>    <span class='st'>"French Southern and Antarctic Lands"</span>,</span>
<span>    <span class='st'>"Micronesia"</span>, <span class='st'>"Marshall Islands"</span>, <span class='st'>"Kiribati"</span>,</span>
<span>    <span class='st'>"Tuvalu"</span>, <span class='st'>"American Samoa"</span>, <span class='st'>"Solomon Islands"</span>,</span>
<span>    <span class='st'>"Vanuatu"</span>, <span class='st'>"New Caledonia"</span>, <span class='st'>"Fiji"</span>, <span class='st'>"Samoa"</span>,</span>
<span>    <span class='st'>"Tonga"</span>, <span class='st'>"Cook Islands"</span>, <span class='st'>"Wallis and Futuna"</span>,</span>
<span>    <span class='st'>"Niue"</span>, <span class='st'>"Tokelau"</span>, <span class='st'>"French Polynesia"</span>,</span>
<span>    <span class='st'>"Pitcairn Islands"</span>, <span class='st'>"Comoros"</span>, <span class='st'>"Mauritius"</span>, <span class='st'>"Seychelles"</span>,</span>
<span>    <span class='st'>"Maldives"</span>, <span class='st'>"Cape Verde"</span>, <span class='st'>"Sao Tome and Principe"</span>,</span>
<span>    <span class='st'>"Saint Helena"</span>, <span class='st'>"Palau"</span>, <span class='st'>"Northern Mariana Islands"</span>,</span>
<span>    <span class='st'>"Nauru"</span>, <span class='st'>"Christmas Island"</span>, <span class='st'>"Cocos Islands"</span>,</span>
<span>    <span class='st'>"Norfolk Island"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>  <span class='co'># filter out all Pacific islands except for Australia</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='op'>!</span><span class='op'>(</span><span class='va'>long</span> <span class='op'>&gt;</span> <span class='fl'>140</span> <span class='op'>&amp;</span> <span class='va'>lat</span> <span class='op'>&lt;</span> <span class='fl'>30</span> <span class='op'>&amp;</span> <span class='va'>lat</span> <span class='op'>&gt;</span> <span class='op'>-</span><span class='fl'>30</span><span class='op'>)</span> <span class='op'>|</span> <span class='va'>region</span> <span class='op'>==</span> <span class='st'>"Australia"</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># filter out Antarctica</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>lat</span> <span class='op'>&gt;</span> <span class='op'>-</span><span class='fl'>60</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>The original visualization has distinctive layers. These layers create some
‘depth effect’. The land masses are bordered by a small dark grey buffer zone.
And this buffer zone is bordered by another slightly larger light grey buffer
zone. In the following, we will create these buffers or layers. I estimate that
the large buffer is about three times larger than the small buffer.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># small buffer - closest to the actual landmass</span></span>
<span><span class='va'>buffer_small</span> <span class='op'>&lt;-</span> <span class='va'>world_map</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>group</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    long <span class='op'>=</span> <span class='va'>long</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/sign.html'>sign</a></span><span class='op'>(</span><span class='va'>long</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>long</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>1.25</span>,</span>
<span>    lat <span class='op'>=</span> <span class='va'>lat</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/sign.html'>sign</a></span><span class='op'>(</span><span class='va'>lat</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>lat</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>1.25</span><span class='op'>)</span> </span>
<span></span>
<span><span class='co'># large buffer - creates the outermost layer</span></span>
<span><span class='va'>buffer_large</span> <span class='op'>&lt;-</span> <span class='va'>world_map</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>group</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    long <span class='op'>=</span> <span class='va'>long</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/sign.html'>sign</a></span><span class='op'>(</span><span class='va'>long</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>long</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>3.75</span>,</span>
<span>    lat <span class='op'>=</span> <span class='va'>lat</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/sign.html'>sign</a></span><span class='op'>(</span><span class='va'>lat</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>lat</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>3.75</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>We will use the “Gudea” font which comes closest to the font used in the
original plot. We used <a href="https://www.myfonts.com/pages/whatthefont">myfonts.com</a> to detect the font.</p>
<p>Now we can plot the world map.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># get the font right</span></span>
<span><span class='fu'>sysfonts</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/sysfonts/man/font_add_google.html'>font_add_google</a></span><span class='op'>(</span><span class='st'>"Gudea"</span>, family <span class='op'>=</span> <span class='st'>"gudea"</span><span class='op'>)</span> </span>
<span><span class='fu'>showtext</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/showtext/man/showtext_auto.html'>showtext_auto</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># create the basic world map with layers</span></span>
<span><span class='va'>p</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'># sea layer (furthest)</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_polygon.html'>geom_polygon</a></span><span class='op'>(</span></span>
<span>    data <span class='op'>=</span> <span class='va'>buffer_large</span>, </span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, group <span class='op'>=</span> <span class='va'>group</span><span class='op'>)</span>,</span>
<span>    fill <span class='op'>=</span> <span class='st'>"#ffffff"</span>,</span>
<span>    alpha <span class='op'>=</span> <span class='fl'>0.15</span>,</span>
<span>    color <span class='op'>=</span> <span class='cn'>NA</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'># second transition layer</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_polygon.html'>geom_polygon</a></span><span class='op'>(</span></span>
<span>    data <span class='op'>=</span> <span class='va'>buffer_large</span>, </span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, group <span class='op'>=</span> <span class='va'>group</span><span class='op'>)</span>,</span>
<span>    fill <span class='op'>=</span> <span class='st'>"#f9f9f9"</span>, </span>
<span>    color <span class='op'>=</span> <span class='cn'>NA</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'># first transition layer</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_polygon.html'>geom_polygon</a></span><span class='op'>(</span></span>
<span>    data <span class='op'>=</span> <span class='va'>buffer_small</span>, </span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, group <span class='op'>=</span> <span class='va'>group</span><span class='op'>)</span>,</span>
<span>    fill <span class='op'>=</span> <span class='st'>"#eff0f0"</span>, </span>
<span>    color <span class='op'>=</span> <span class='cn'>NA</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'># land layer (topmost)</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_polygon.html'>geom_polygon</a></span><span class='op'>(</span></span>
<span>    data <span class='op'>=</span> <span class='va'>world_map</span>, </span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, group <span class='op'>=</span> <span class='va'>group</span><span class='op'>)</span>,</span>
<span>    fill <span class='op'>=</span> <span class='st'>"#ffffff"</span>,</span>
<span>    alpha <span class='op'>=</span> <span class='fl'>0.95</span>,</span>
<span>    color <span class='op'>=</span> <span class='st'>"#b8c6c7"</span>,</span>
<span>    size <span class='op'>=</span> <span class='fl'>0.1</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'># set the coordinate system and aspect ratio</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_fixed.html'>coord_fixed</a></span><span class='op'>(</span><span class='fl'>1.3</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'># remove axes and grid</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_void</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'># customize the theme</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span></span>
<span>    panel.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#ffffff"</span><span class='op'>)</span>,</span>
<span>    plot.background <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_rect</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"#ffffff"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># display the base map</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/unnamed-chunk-9-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<h3 id="country-labels-and-annotations">2. Country labels and annotations</h3>
<h4 id="positioning-of-country-labels">Positioning of country labels</h4>
<p>First, we need to get the country names right. To this end, we create a mapping
<em>from</em> the semi-official country names <em>to</em> the names used in the visualisation.
Note that this mapping defines how the country names eventually appear on the
map, whereas the standardisation in country_name_mapping was about matching the
names in the trade dataset with the names used in the map data.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>country_labels</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>  Country <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>    <span class='co'># all the countries in the plot</span></span>
<span>    <span class='st'>"Belgium"</span>, <span class='st'>"Netherlands"</span>, <span class='st'>"Germany"</span>, <span class='st'>"France"</span>, <span class='st'>"Italy"</span>, </span>
<span>    <span class='st'>"Switzerland"</span>, <span class='st'>"Austria"</span>, <span class='st'>"Spain"</span>, <span class='st'>"UK"</span>,</span>
<span>    <span class='st'>"USA"</span>, <span class='st'>"Canada"</span>, <span class='st'>"Mexico"</span>, <span class='st'>"Brazil"</span>, <span class='st'>"Peru"</span>, <span class='st'>"Chile"</span>, <span class='st'>"Norway"</span>,</span>
<span>    <span class='st'>"Russia"</span>, <span class='st'>"China"</span>, <span class='st'>"Japan"</span>, <span class='st'>"South Korea"</span>, <span class='st'>"India"</span>, <span class='st'>"Australia"</span>,</span>
<span>    <span class='st'>"Indonesia"</span>, <span class='st'>"Malaysia"</span>, <span class='st'>"Thailand"</span>, <span class='st'>"Hong Kong"</span>,</span>
<span>    <span class='st'>"UAE"</span>, <span class='st'>"Saudi Arabia"</span>, <span class='st'>"Kuwait"</span>, <span class='st'>"Qatar"</span>, <span class='st'>"Oman"</span>, <span class='st'>"Iraq"</span>, <span class='st'>"Azerbaijan"</span>,</span>
<span>    <span class='st'>"Turkey"</span>, <span class='st'>"Algeria"</span>, <span class='st'>"Angola"</span>, <span class='st'>"South Africa"</span><span class='op'>)</span>,</span>
<span>  <span class='co'># the actual labels of all the countries in the plot</span></span>
<span>  Label <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>    <span class='st'>"Bel"</span>, <span class='st'>"Nld"</span>, <span class='st'>"Germany"</span>, <span class='st'>"Fra"</span>, <span class='st'>"Italy"</span>, <span class='st'>"Swi"</span>, <span class='st'>"Austria"</span>, <span class='st'>"Spain"</span>, <span class='st'>"UK"</span>,</span>
<span>    <span class='st'>"United States"</span>, <span class='st'>"Canada"</span>, <span class='st'>"Mexico"</span>, <span class='st'>"Brazil"</span>, <span class='st'>"Peru"</span>, <span class='st'>"Chile"</span>, <span class='st'>"Norway"</span>,</span>
<span>    <span class='st'>"Russia"</span>, <span class='st'>"China"</span>, <span class='st'>"Japan"</span>, <span class='st'>"Korea, \nRep."</span>, <span class='st'>"India"</span>, <span class='st'>"Australia"</span>,</span>
<span>    <span class='st'>"Indonesia"</span>, <span class='st'>"Malaysia"</span>, <span class='st'>"Thailand"</span>, <span class='st'>"Hong Kong"</span>,</span>
<span>    <span class='st'>"UAE"</span>, <span class='st'>"Saudi \nArabia"</span>, <span class='st'>"Kuwait"</span>, <span class='st'>"Qatar"</span>, <span class='st'>"Oman"</span>, <span class='st'>"Iraq"</span>, <span class='st'>"Azerbaijan"</span>,</span>
<span>    <span class='st'>"Turkey"</span>, <span class='st'>"Algeria"</span>, <span class='st'>"Angola"</span>, <span class='st'>"South Africa"</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>We also need to add coordinates for the two special areas:
“Rest of America, nes” and “Areas, nes”. Here, “nes” stands for “not elsewhere
specified” and refers to unknown trading partners. This can occur when reporting
countries do not submit details about the trading partner, either due to low-
value trade or to protect company information. “Rest of America, nes” represents
unspecified trading partners specifically within the Americas. We need to do
this manually:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>special_areas_coords</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>  Country <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Areas, nes"</span>, <span class='st'>"Rest of America, nes"</span><span class='op'>)</span>,</span>
<span>  long <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>4.46</span>, <span class='op'>-</span><span class='fl'>111.861620</span><span class='op'>)</span>,</span>
<span>  lat <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>50.49</span>, <span class='fl'>1.691649</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>One of the key challenges in replicating this visualization is the precise
positioning of country labels. The country labels are also the start and end
points of the trade flows. Thus, we really do need to get the labels’ positions
right to match the original plot.</p>
<p>The positions of the country labels are not in the dataset. But we can
automatically determine the positions by calculating the centroid of each
country and placing it at this point.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># calculate basic country centroids</span></span>
<span><span class='va'>country_coords</span> <span class='op'>&lt;-</span> <span class='va'>world_map</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>region</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span></span>
<span>    long <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>long</span><span class='op'>)</span>,</span>
<span>    lat <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>lat</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span>  </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>Country <span class='op'>=</span> <span class='va'>region</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># combine the country_coords with the special_areas_coords</span></span>
<span><span class='va'>all_coords</span> <span class='op'>&lt;-</span> <span class='va'>country_coords</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind_rows.html'>bind_rows</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># prepare the trade flow data by adding start and end coordinates for each flow</span></span>
<span><span class='co'># we do this here since we have just created our complete coordinate system and</span></span>
<span><span class='co'># we will need this data structure for both label positioning and trade flow</span></span>
<span><span class='co'># visualisation later</span></span>
<span><span class='va'>data_2_filtered_with_coords</span> <span class='op'>&lt;-</span> <span class='va'>data_2_filtered</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>all_coords</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Exporter"</span> <span class='op'>=</span> <span class='st'>"Country"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>Export_Long <span class='op'>=</span> <span class='va'>long</span>, Export_Lat <span class='op'>=</span> <span class='va'>lat</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>all_coords</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Importer"</span> <span class='op'>=</span> <span class='st'>"Country"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>Import_Long <span class='op'>=</span> <span class='va'>long</span>, Import_Lat <span class='op'>=</span> <span class='va'>lat</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>Now we can create a plot with the labels positioned at the countries’ centroids.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>p</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span></span>
<span>    data <span class='op'>=</span> <span class='va'>country_labels</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>all_coords</span>, by <span class='op'>=</span> <span class='st'>"Country"</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>    size <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/unnamed-chunk-13-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<p>The positions of the country labels do not match the positions in the original
plot. For instance, the label “United States” is located at the North-West of
the US. This is because of Alaska shifting the centroid in this direction.
Additionally, the labels in Europe and the Middle East are too cluttered.
We can try <code>geom_text_repel()</code> from the ggrepel package which automatically
adjusts label positions to avoid overlaps while trying to keep labels close to
their associated points.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>p</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html'>geom_text_repel</a></span><span class='op'>(</span></span>
<span>    data <span class='op'>=</span> <span class='va'>country_labels</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>all_coords</span>, by <span class='op'>=</span> <span class='st'>"Country"</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>    size <span class='op'>=</span> <span class='fl'>3</span>,</span>
<span>    max.overlaps <span class='op'>=</span> <span class='cn'>Inf</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/unnamed-chunk-14-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<p>While <code>geom_text_repel()</code> solves the issue of cluttered labels in Europe and the
Middle East, the positions of the labels still do not match the ones in the
original plot.</p>
<p>Note that an approach using the capital cities as reference points for the
country labels does not work either. We have no alternative but to place the
country labels manually, again using a longitude and latitude finder in the web.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># custom coordinates of country labels</span></span>
<span><span class='va'>label_adjustments</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>  Country <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>    <span class='co'># South America</span></span>
<span>    <span class='st'>"Peru"</span>, <span class='st'>"Brazil"</span>, <span class='st'>"Chile"</span>,</span>
<span>    <span class='co'># North America</span></span>
<span>    <span class='st'>"USA"</span>, <span class='st'>"Canada"</span>, <span class='st'>"Mexico"</span>,</span>
<span>    <span class='co'># Asia</span></span>
<span>    <span class='st'>"Russia"</span>, <span class='st'>"India"</span>, <span class='st'>"Indonesia"</span>, <span class='st'>"Malaysia"</span>, <span class='st'>"Thailand"</span>, <span class='st'>"China"</span>, <span class='st'>"Japan"</span>, </span>
<span>    <span class='st'>"South Korea"</span>, <span class='st'>"Oman"</span>, <span class='st'>"UAE"</span>, <span class='st'>"Qatar"</span>, <span class='st'>"Saudi Arabia"</span>, <span class='st'>"Kuwait"</span>, <span class='st'>"Iraq"</span>,</span>
<span>    <span class='st'>"Hong Kong"</span>,</span>
<span>    <span class='co'># Europe</span></span>
<span>    <span class='st'>"Norway"</span>, <span class='st'>"Turkey"</span>, <span class='st'>"Azerbaijan"</span>, <span class='st'>"Spain"</span>, <span class='st'>"France"</span>, <span class='st'>"Italy"</span>, <span class='st'>"UK"</span>,</span>
<span>    <span class='st'>"Belgium"</span>, <span class='st'>"Germany"</span>, <span class='st'>"Switzerland"</span>, <span class='st'>"Netherlands"</span>, <span class='st'>"Austria"</span>,</span>
<span>    <span class='co'># Africa</span></span>
<span>    <span class='st'>"South Africa"</span>, <span class='st'>"Angola"</span>, <span class='st'>"Algeria"</span>,</span>
<span>    <span class='co'># Australia</span></span>
<span>    <span class='st'>"Australia"</span><span class='op'>)</span>,</span>
<span>  </span>
<span>  long <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>    <span class='co'># South America</span></span>
<span>    <span class='op'>-</span><span class='fl'>75.951872</span>, <span class='op'>-</span><span class='fl'>56.385277</span>, <span class='op'>-</span><span class='fl'>70.830462</span>,</span>
<span>    <span class='co'># North America</span></span>
<span>    <span class='op'>-</span><span class='fl'>99.308645</span>, <span class='op'>-</span><span class='fl'>95.202345</span>, <span class='op'>-</span><span class='fl'>101.812930</span>,</span>
<span>    <span class='co'># Asia</span></span>
<span>    <span class='fl'>71.909173</span>, <span class='fl'>77.324934</span>, <span class='fl'>119.847050</span>, <span class='fl'>112.765282</span>, <span class='fl'>101.445301</span>, <span class='fl'>102.411087</span>, </span>
<span>    <span class='fl'>139.182451</span>, <span class='fl'>127.749200</span>, <span class='fl'>58.621072</span>, <span class='fl'>57.301851</span>, <span class='fl'>55.324885</span>, <span class='fl'>37.991606</span>, </span>
<span>    <span class='fl'>44.178739</span>, <span class='fl'>40.544111</span>, <span class='fl'>115.203854</span>,</span>
<span>    <span class='co'># Europe</span></span>
<span>    <span class='fl'>10.406986</span>, <span class='fl'>29.882086</span>, <span class='fl'>50.675979</span>, <span class='op'>-</span><span class='fl'>4.881616</span>, <span class='fl'>0.155130</span>, <span class='fl'>11.260573</span>, <span class='op'>-</span><span class='fl'>6.355075</span>,</span>
<span>    <span class='fl'>0.450087</span>, <span class='fl'>18.697300</span>, <span class='fl'>7.885837</span>, <span class='fl'>1.838480</span>, <span class='fl'>19.122010</span>,</span>
<span>    <span class='co'># Africa</span></span>
<span>    <span class='fl'>25.354109</span>, <span class='fl'>18.169549</span>, <span class='fl'>2.914381</span>,</span>
<span>    <span class='co'># Australia</span></span>
<span>    <span class='fl'>133.363988</span><span class='op'>)</span>,</span>
<span>  </span>
<span>  lat <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>    <span class='co'># South America</span></span>
<span>    <span class='op'>-</span><span class='fl'>10.772603</span>, <span class='op'>-</span><span class='fl'>10.569497</span>, <span class='op'>-</span><span class='fl'>30.133251</span>,</span>
<span>    <span class='co'># North America</span></span>
<span>    <span class='fl'>38.649053</span>, <span class='fl'>60.089502</span>, <span class='fl'>22.549343</span>,</span>
<span>    <span class='co'># Asia</span></span>
<span>    <span class='fl'>61.363171</span>, <span class='fl'>20.014000</span>, <span class='op'>-</span><span class='fl'>4.952090</span>, <span class='fl'>1.019271</span>, <span class='fl'>14.721046</span>, <span class='fl'>35.037486</span>, <span class='fl'>33.954752</span>, </span>
<span>    <span class='fl'>37.660866</span>, <span class='fl'>15.703697</span>, <span class='fl'>21.612749</span>, <span class='fl'>26.063568</span>, <span class='fl'>21.687738</span>, <span class='fl'>29.666373</span>, <span class='fl'>33.928121</span>,</span>
<span>    <span class='fl'>21.943046</span>,</span>
<span>    <span class='co'># Europe</span></span>
<span>    <span class='fl'>61.160132</span>, <span class='fl'>39.118608</span>, <span class='fl'>40.019727</span>, <span class='fl'>39.139647</span>, <span class='fl'>43.635898</span>, <span class='fl'>39.739402</span>, <span class='fl'>55.073748</span>,</span>
<span>    <span class='fl'>48.931973</span>, <span class='fl'>52.130221</span>, <span class='fl'>47.172791</span>, <span class='fl'>56.207238</span>, <span class='fl'>44.663403</span>,</span>
<span>    <span class='co'># Africa</span></span>
<span>    <span class='op'>-</span><span class='fl'>29.271098</span>, <span class='op'>-</span><span class='fl'>13.306108</span>, <span class='fl'>27.232120</span>,</span>
<span>    <span class='co'># Australia</span></span>
<span>    <span class='op'>-</span><span class='fl'>24.820393</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># apply the adjustments to our labels</span></span>
<span><span class='va'>country_labels_adj</span> <span class='op'>&lt;-</span> <span class='va'>country_labels</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>label_adjustments</span>, by <span class='op'>=</span> <span class='st'>"Country"</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># Add adjusted labels to our map</span></span>
<span><span class='va'>p</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span></span>
<span>    data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>        size <span class='op'>=</span> <span class='fl'>1.65</span>, fontface <span class='op'>=</span> <span class='st'>"bold"</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/unnamed-chunk-16-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<p>Now, the positions of the country labels match the ones in the original plot
quite well.</p>
<h4 id="refinement-of-labels">Refinement of labels</h4>
<p>While the country labels are now correctly positioned, we still need to do fine-
tuning to match the original plot’s labels. The original plot has some text
halo effect. This does not only look nice but also ensures better readability
when labels overlap with trade flows. We recreate this halo effect as follows:</p>
<ul>
<li>Place multiple white labels behind each text label (which is black)</li>
<li>Use slightly larger white text (size 1.75-1.77) than black text
(size 1.65) to create a solid white outline</li>
</ul>
<p>In this step, we will also add the two “nes” areas.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>p</span> <span class='op'>&lt;-</span> <span class='va'>p</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span> <span class='op'>-</span> <span class='fl'>0.1</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.75</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            <span class='co'># we need to adjust the lineheight argument for "Korea, \nRep." and </span></span>
<span>            <span class='co'># "Saudi \n Arabia" to make sure that the vertical spacing is fine</span></span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span> <span class='op'>+</span> <span class='fl'>0.1</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.75</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span> <span class='op'>-</span> <span class='fl'>0.1</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.75</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span> <span class='op'>+</span> <span class='fl'>0.1</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.75</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  </span>
<span>  <span class='co'># add country labels (white)</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.77</span>,  <span class='co'># slightly larger than the black text</span></span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  </span>
<span>  <span class='co'># add country labels (black)</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.65</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  </span>
<span>  <span class='co'># add rectangles for nes areas</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_tile.html'>geom_rect</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>    xmin <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>11.75</span>, </span>
<span>             <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>2</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>22.5</span><span class='op'>)</span>,</span>
<span>    xmax <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>]</span>  <span class='op'>+</span> <span class='fl'>11.75</span>, </span>
<span>             <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>2</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>22.5</span><span class='op'>)</span>,</span>
<span>    ymin <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>2.6</span>, </span>
<span>             <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>3</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>2.6</span><span class='op'>)</span>,</span>
<span>    ymax <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>2.6</span>, </span>
<span>             <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>3</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>2.6</span><span class='op'>)</span>,</span>
<span>    label <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Areas, nes"</span>, <span class='st'>"Rest of America, nes"</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>xmin <span class='op'>=</span> <span class='va'>xmin</span>, xmax <span class='op'>=</span> <span class='va'>xmax</span>, ymin <span class='op'>=</span> <span class='va'>ymin</span>, ymax <span class='op'>=</span> <span class='va'>ymax</span><span class='op'>)</span>,</span>
<span>    fill <span class='op'>=</span> <span class='st'>"#ffffff"</span>,</span>
<span>    alpha <span class='op'>=</span> <span class='fl'>.9</span>,</span>
<span>    color <span class='op'>=</span> <span class='st'>"#cccccc"</span>, </span>
<span>    size <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  </span>
<span>  <span class='co'># add text labels for nes areas</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>]</span>, <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>,</span>
<span>    y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>]</span>, <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>3</span><span class='op'>]</span><span class='op'>)</span>,</span>
<span>    label <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Areas, nes"</span>, <span class='st'>"Rest of America, nes"</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span>, label <span class='op'>=</span> <span class='va'>label</span><span class='op'>)</span>,</span>
<span>    size <span class='op'>=</span> <span class='fl'>1.65</span>, </span>
<span>    fontface <span class='op'>=</span> <span class='st'>"bold"</span><span class='op'>)</span>  <span class='op'>+</span> </span>
<span>  </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>text <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_text</a></span><span class='op'>(</span>family <span class='op'>=</span> <span class='st'>"gudea"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/unnamed-chunk-17-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<h4 id="annotations">Annotations</h4>
<p>Finally, we can add the legend ‘Scale’ in the bottom-left. This legend helps
reader understand the trade flows more easily by showing how the thickness of
the flows corresponds to trade volume. We leave out the other annotations
as these do not add anything meaningful to the plot.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>p</span> <span class='op'>&lt;-</span> <span class='va'>p</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/annotation_custom.html'>annotation_custom</a></span><span class='op'>(</span></span>
<span>    <span class='fu'>grid</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/r/grid/grid.raster.html'>rasterGrob</a></span><span class='op'>(</span></span>
<span>      <span class='fu'>png</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/png/man/readPNG.html'>readPNG</a></span><span class='op'>(</span><span class='st'>"legend.png"</span><span class='op'>)</span>,</span>
<span>      x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grid/unit.html'>unit</a></span><span class='op'>(</span><span class='fl'>0.15</span>, <span class='st'>"npc"</span><span class='op'>)</span>,</span>
<span>      y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grid/unit.html'>unit</a></span><span class='op'>(</span><span class='fl'>0.15</span>, <span class='st'>"npc"</span><span class='op'>)</span>,</span>
<span>      width <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grid/unit.html'>unit</a></span><span class='op'>(</span><span class='fl'>0.1</span>, <span class='st'>"npc"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/unnamed-chunk-18-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<h3 id="trade-flows">3. Trade flows</h3>
<p>The most complex part of this visualization is the trade flows. In the original
plot the trade flows have a unique leftward curvature. They start from the
exporting country and curve left before turning right at about halfway to the
importing country. Moreover, the flows get progressively larger: the flows are
very thin at their starting point (the exporting country) and get larger as they
reach the importing country. Additionally, the colour of the flows changes as
they progress. Finally, the flows have an arrow which shows the
directionality of trade.</p>
<h4 id="prepare-trade-flow-coordinates">Prepare trade flow coordinates</h4>
<p>Before we can create the trade flows, we need to ensure we have the correct
coordinates for both the start (exporter) and end (importer) of each flow.
These coordinates should match the positions of our manually adjusted country
labels rather than the geographical centroids we initially calculated.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># merge our manual label positions with the trade flow data</span></span>
<span><span class='va'>data_2_filtered_with_coords</span> <span class='op'>&lt;-</span> <span class='va'>data_2_filtered</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># join with label_adjustments for exporter coordinates</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>label_adjustments</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Exporter"</span> <span class='op'>=</span> <span class='st'>"Country"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>Export_Long <span class='op'>=</span> <span class='va'>long</span>, Export_Lat <span class='op'>=</span> <span class='va'>lat</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># join again with label_adjustments for importer coordinates</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>label_adjustments</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Importer"</span> <span class='op'>=</span> <span class='st'>"Country"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>Import_Long <span class='op'>=</span> <span class='va'>long</span>, Import_Lat <span class='op'>=</span> <span class='va'>lat</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># update any missing coordinates</span></span>
<span><span class='va'>data_2_filtered_with_coords</span> <span class='op'>&lt;-</span> <span class='va'>data_2_filtered_with_coords</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Exporter"</span> <span class='op'>=</span> <span class='st'>"Country"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    Export_Long <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/coalesce.html'>coalesce</a></span><span class='op'>(</span><span class='va'>Export_Long</span>, <span class='va'>long</span><span class='op'>)</span>,</span>
<span>    Export_Lat <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/coalesce.html'>coalesce</a></span><span class='op'>(</span><span class='va'>Export_Lat</span>, <span class='va'>lat</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>long</span>, <span class='op'>-</span><span class='va'>lat</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Importer"</span> <span class='op'>=</span> <span class='st'>"Country"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    Import_Long <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/coalesce.html'>coalesce</a></span><span class='op'>(</span><span class='va'>Import_Long</span>, <span class='va'>long</span><span class='op'>)</span>,</span>
<span>    Import_Lat <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/coalesce.html'>coalesce</a></span><span class='op'>(</span><span class='va'>Import_Lat</span>, <span class='va'>lat</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>long</span>, <span class='op'>-</span><span class='va'>lat</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h4 id="calculating-bezier-curves">Calculating Bezier curves</h4>
<p>Rather than directly using <code>geom_bezier()</code>, we create a custom function to
calculate the Bezier curves. The reason for this decision is that we will later
need to add arrows embedded in the trade flows. These arrows follow the same
path as the trade flows but end a bit before the trade flows. Calculating the
Bezier curves ourselves allows us to access and control the curve coordinates,
which is necessary to make the arrows shorter than the trade flows. This was
difficult to achieve with <code>geom_bezier()</code>.</p>
<p>We go for simpler quadratic Bezier curves which use just one control point.
Here is the function that calculates these curves:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>calculate_bezier_points</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x1</span>, <span class='va'>y1</span>, <span class='va'>cx</span>, <span class='va'>cy</span>, <span class='va'>x2</span>, <span class='va'>y2</span>, <span class='va'>n</span> <span class='op'>=</span> <span class='fl'>100</span>, </span>
<span>                                  <span class='va'>start_offset</span> <span class='op'>=</span> <span class='fl'>2</span>, <span class='va'>end_offset</span> <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  </span>
<span>  <span class='co'># calculate points along the Bezier curve</span></span>
<span>  <span class='va'>t</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span>, length.out <span class='op'>=</span> <span class='va'>n</span><span class='op'>)</span></span>
<span>  <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>t</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>*</span> <span class='va'>x1</span> <span class='op'>+</span> <span class='fl'>2</span><span class='op'>*</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>t</span><span class='op'>)</span><span class='op'>*</span><span class='va'>t</span> <span class='op'>*</span> <span class='va'>cx</span> <span class='op'>+</span> <span class='va'>t</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>*</span> <span class='va'>x2</span></span>
<span>  <span class='va'>y</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>t</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>*</span> <span class='va'>y1</span> <span class='op'>+</span> <span class='fl'>2</span><span class='op'>*</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>t</span><span class='op'>)</span><span class='op'>*</span><span class='va'>t</span> <span class='op'>*</span> <span class='va'>cy</span> <span class='op'>+</span> <span class='va'>t</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>*</span> <span class='va'>y2</span></span>
<span>  <span class='va'>points</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='co'># calculate distances from endpoints</span></span>
<span>  <span class='va'>start_distances</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='op'>(</span><span class='va'>x</span> <span class='op'>-</span> <span class='va'>x1</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>+</span> <span class='op'>(</span><span class='va'>y</span> <span class='op'>-</span> <span class='va'>y1</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span></span>
<span>  <span class='va'>end_distances</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='op'>(</span><span class='va'>x</span> <span class='op'>-</span> <span class='va'>x2</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>+</span> <span class='op'>(</span><span class='va'>y</span> <span class='op'>-</span> <span class='va'>y2</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='co'># filter points based on offset</span></span>
<span>  <span class='va'>valid_points</span> <span class='op'>&lt;-</span> <span class='va'>points</span><span class='op'>[</span><span class='va'>start_distances</span> <span class='op'>&gt;=</span> <span class='va'>start_offset</span> <span class='op'>&amp;</span> </span>
<span>                        <span class='va'>end_distances</span> <span class='op'>&gt;=</span> <span class='va'>end_offset</span>, <span class='op'>]</span></span>
<span>  </span>
<span>  <span class='co'># safety check: in case we filtered out too many points, </span></span>
<span>  <span class='co'># return a minimal valid set</span></span>
<span>  <span class='co'># rule: if filtering left us with fewer than 3 points </span></span>
<span>  <span class='co'># (which would create a poor curve), then: </span></span>
<span>    <span class='co'># (1) take just 3 points along the curve (at 15%, 50%, and 85% of the way)</span></span>
<span>    <span class='co'># (2) calculate their positions using the same Bezier formula</span></span>
<span>    <span class='co'># (3) use these as our points instead</span></span>
<span>  <span class='kw'>if</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>valid_points</span><span class='op'>)</span> <span class='op'>&lt;</span> <span class='fl'>3</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='va'>t_subset</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.15</span>, <span class='fl'>0.5</span>, <span class='fl'>0.85</span><span class='op'>)</span></span>
<span>    <span class='va'>x_subset</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>t_subset</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>*</span> <span class='va'>x1</span> <span class='op'>+</span> </span>
<span>      <span class='fl'>2</span><span class='op'>*</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>t_subset</span><span class='op'>)</span><span class='op'>*</span><span class='va'>t_subset</span> <span class='op'>*</span> <span class='va'>cx</span> <span class='op'>+</span> <span class='va'>t_subset</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>*</span> <span class='va'>x2</span></span>
<span>    <span class='va'>y_subset</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>t_subset</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>*</span> <span class='va'>y1</span> <span class='op'>+</span> </span>
<span>      <span class='fl'>2</span><span class='op'>*</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>-</span><span class='va'>t_subset</span><span class='op'>)</span><span class='op'>*</span><span class='va'>t_subset</span> <span class='op'>*</span> <span class='va'>cy</span> <span class='op'>+</span> <span class='va'>t_subset</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>*</span> <span class='va'>y2</span></span>
<span>    <span class='va'>valid_points</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x_subset</span>, y <span class='op'>=</span> <span class='va'>y_subset</span><span class='op'>)</span></span>
<span>  <span class='op'>}</span></span>
<span>  </span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>valid_points</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span></code></pre>
</div>
</div>
<p>We add some offset to the start and end. Removing points that are too close to<br />
the start or end points will avoid overlap of the trade flows with the country
labels. For some specific cases, we will later use custom offsets.</p>
<h4 id="creating-initial-trade-flows">Creating initial trade flows</h4>
<p>Now that we have our custom function to calculate Bezier curves, we need to
determine where we want to place the control point for each trade flow.
This control point will define how each curve bends. The process is as follows:</p>
<ol type="1">
<li><p>Find the midpoint between the origin and destination of each trade flow</p></li>
<li><p>Calculate how far to offset this midpoint perpendicular to the direction</p></li>
<li><p>Convert the flows into a format with three points: start, control, and end</p></li>
</ol>
<p>For the offset calculation, we make it proportional to the distance between
countries: longer trade flows get larger offsets, creating more pronounced
curves. These decisions are based on a careful observation of the original
visualisation.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># calculate control points for Bezier curves</span></span>
<span><span class='va'>trade_flows_with_bezier</span> <span class='op'>&lt;-</span> <span class='va'>data_2_filtered_with_coords</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rowwise.html'>rowwise</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    <span class='co'># calculate midpoint for control point</span></span>
<span>    xm <span class='op'>=</span> <span class='op'>(</span><span class='va'>Export_Long</span> <span class='op'>+</span> <span class='va'>Import_Long</span><span class='op'>)</span><span class='op'>/</span><span class='fl'>2</span>,</span>
<span>    ym <span class='op'>=</span> <span class='op'>(</span><span class='va'>Export_Lat</span> <span class='op'>+</span> <span class='va'>Import_Lat</span><span class='op'>)</span><span class='op'>/</span><span class='fl'>2</span>,</span>
<span>    </span>
<span>    <span class='co'># calculate offset for control point</span></span>
<span>    dx <span class='op'>=</span> <span class='va'>Import_Long</span> <span class='op'>-</span> <span class='va'>Export_Long</span>,</span>
<span>    dy <span class='op'>=</span> <span class='va'>Import_Lat</span> <span class='op'>-</span> <span class='va'>Export_Lat</span>,</span>
<span>    dist <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='va'>dx</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>+</span> <span class='va'>dy</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span>,</span>
<span>    offset <span class='op'>=</span> <span class='fl'>0.25</span> <span class='op'>*</span> <span class='va'>dist</span>,  <span class='co'># the result of a lot of testing</span></span>
<span>    </span>
<span>    <span class='co'># calculate control point with offset</span></span>
<span>    control_x <span class='op'>=</span> <span class='va'>xm</span> <span class='op'>-</span> <span class='va'>offset</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>Import_Lat</span> <span class='op'>-</span> <span class='va'>Export_Lat</span><span class='op'>)</span><span class='op'>/</span><span class='va'>dist</span>,</span>
<span>    control_y <span class='op'>=</span> <span class='va'>ym</span> <span class='op'>+</span> <span class='va'>offset</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>Import_Long</span> <span class='op'>-</span> <span class='va'>Export_Long</span><span class='op'>)</span><span class='op'>/</span><span class='va'>dist</span><span class='op'>)</span> <span class='op'>|&gt;</span>  </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># create three rows per flow (start, control, end points)</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>Exporter</span>, <span class='va'>Importer</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarise</a></span><span class='op'>(</span></span>
<span>    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>Export_Long</span>, <span class='va'>control_x</span>, <span class='va'>Import_Long</span><span class='op'>)</span>,</span>
<span>    y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>Export_Lat</span>, <span class='va'>control_y</span>, <span class='va'>Import_Lat</span><span class='op'>)</span>,</span>
<span>    point <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>3</span>,</span>
<span>    Total_Value <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/nth.html'>first</a></span><span class='op'>(</span><span class='va'>Total_Value</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h4 id="custom-offsets">Custom offsets</h4>
<p>The case of China needs special care as it is the most cluttered label.
Specifically, we need to use custom offsets for all the trade flows to China
that come from the West or North. If we did not use these, the ends of the trade
flows would overlap too much with the label “China”.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># first identify links to China that need special handling</span></span>
<span><span class='va'>china_exporters_not_South</span> <span class='op'>&lt;-</span> <span class='va'>data_2_filtered_with_coords</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>Importer</span> <span class='op'>==</span> <span class='st'>"China"</span>, <span class='op'>!</span><span class='va'>Exporter</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> </span>
<span>           <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Malaysia"</span>, <span class='st'>"Thailand"</span>, <span class='st'>"Australia"</span>, <span class='st'>"Hong Kong"</span>, <span class='st'>"Indonesia"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/pull.html'>pull</a></span><span class='op'>(</span><span class='va'>Exporter</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># set custom offsets for specific trade routes</span></span>
<span><span class='va'>custom_offsets</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>  Exporter <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Canada"</span>, <span class='st'>"Russia"</span>, <span class='va'>china_exporters_not_South</span><span class='op'>)</span>,</span>
<span>  Importer <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"USA"</span>, <span class='st'>"India"</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='st'>"China"</span>, times <span class='op'>=</span> </span>
<span>                                     <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>china_exporters_not_South</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>  start_offset <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>2.5</span>, <span class='fl'>2</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>2.25</span>, </span>
<span>                               times <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>china_exporters_not_South</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>  end_offset <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1.75</span>, <span class='fl'>2.5</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>6.25</span>, </span>
<span>                                times <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>china_exporters_not_South</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h4 id="final-trade-flows">Final trade flows</h4>
<p>Now we can combine all the previous steps to create our final trade flows.
For each trade flow, we:</p>
<ol type="1">
<li><p>Apply the appropriate offsets (either custom or default) from our previous
calculations</p></li>
<li><p>Generate the curve points using our custom Bezier function</p></li>
<li><p>Scale the thickness of the flows based on trade volume</p></li>
<li><p>Create data for both the full flows and their embedded arrows</p></li>
</ol>
<p>Point 3. is tricky. It is important to recognise that the thickness or sizes of
the trade flows has two parts: the size along each flow and the absolute size of
each flow compared to others.
First, we use a position-based factor (positions^1.1) to account for the varying
size or thickness along each flow. This creates the subtle tapering effect as in
the original plot.
Second, we use the absolute trade value raised to the power of 0.6 for the size
of the entire flow.</p>
<p>Regarding point 4: we create two sets of coordinates for each flow; one for the
full flow path (<code>x_full</code>, <code>y_full</code>) and one for the arrow path
(<code>x_arrow</code>, <code>y_arrow</code>). Again, we would like the arrows to be slightly shorter.</p>
<p>Finally, we use the <code>position</code> variable to create color gradients along each flow.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># calculate bezier points with custom offsets</span></span>
<span><span class='va'>trade_flows_with_points</span> <span class='op'>&lt;-</span> <span class='va'>trade_flows_with_bezier</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>custom_offsets</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Exporter"</span>, <span class='st'>"Importer"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>Exporter</span>, <span class='va'>Importer</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/do.html'>do</a></span><span class='op'>(</span><span class='op'>{</span></span>
<span>    <span class='co'># use the custom offsets (2.25 and 2.5) if they exist</span></span>
<span>    <span class='va'>start_off</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/nth.html'>first</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>$</span><span class='va'>start_offset</span><span class='op'>)</span><span class='op'>)</span>, </span>
<span>                        <span class='fu'><a href='https://dplyr.tidyverse.org/reference/nth.html'>first</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>$</span><span class='va'>start_offset</span><span class='op'>)</span>, <span class='fl'>2.25</span><span class='op'>)</span></span>
<span>    <span class='va'>end_off</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/nth.html'>first</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>$</span><span class='va'>end_offset</span><span class='op'>)</span><span class='op'>)</span>, </span>
<span>                      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/nth.html'>first</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>$</span><span class='va'>end_offset</span><span class='op'>)</span>, <span class='fl'>2.5</span><span class='op'>)</span></span>
<span>    </span>
<span>    <span class='va'>points</span> <span class='op'>&lt;-</span> <span class='fu'>calculate_bezier_points</span><span class='op'>(</span></span>
<span>      <span class='va'>.</span><span class='op'>$</span><span class='va'>x</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>, <span class='va'>.</span><span class='op'>$</span><span class='va'>y</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>,</span>
<span>      <span class='va'>.</span><span class='op'>$</span><span class='va'>x</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span>, <span class='va'>.</span><span class='op'>$</span><span class='va'>y</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span>,</span>
<span>      <span class='va'>.</span><span class='op'>$</span><span class='va'>x</span><span class='op'>[</span><span class='fl'>3</span><span class='op'>]</span>, <span class='va'>.</span><span class='op'>$</span><span class='va'>y</span><span class='op'>[</span><span class='fl'>3</span><span class='op'>]</span>,</span>
<span>      n <span class='op'>=</span> <span class='fl'>100</span>,</span>
<span>      start_offset <span class='op'>=</span> <span class='va'>start_off</span>,</span>
<span>      end_offset <span class='op'>=</span> <span class='va'>end_off</span></span>
<span>    <span class='op'>)</span></span>
<span>    </span>
<span>    <span class='va'>n_points</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>points</span><span class='op'>)</span></span>
<span>    <span class='va'>positions</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span>, length.out <span class='op'>=</span> <span class='va'>n_points</span><span class='op'>)</span></span>
<span>    </span>
<span>    <span class='co'># calculate size scaling</span></span>
<span>    <span class='va'>value_scale</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/nth.html'>first</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>$</span><span class='va'>Total_Value</span><span class='op'>)</span><span class='op'>/</span><span class='fl'>1e6</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>0.6</span></span>
<span>    <span class='va'>thickness</span> <span class='op'>&lt;-</span> <span class='va'>positions</span><span class='op'>^</span><span class='fl'>1.1</span></span>
<span>    <span class='va'>size_scaling</span> <span class='op'>&lt;-</span> <span class='va'>thickness</span> <span class='op'>*</span> <span class='va'>value_scale</span> <span class='op'>*</span> <span class='fl'>0.08</span> <span class='co'>##</span></span>
<span>    <span class='va'>size_scaling</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>pmax</a></span><span class='op'>(</span><span class='fl'>0.01</span>, <span class='va'>size_scaling</span><span class='op'>)</span></span>
<span>    </span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>      x_full <span class='op'>=</span> <span class='va'>points</span><span class='op'>$</span><span class='va'>x</span>,</span>
<span>      y_full <span class='op'>=</span> <span class='va'>points</span><span class='op'>$</span><span class='va'>y</span>,</span>
<span>      x_arrow <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='va'>points</span><span class='op'>$</span><span class='va'>x</span>, <span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span>, <span class='cn'>NA</span><span class='op'>)</span>,</span>
<span>      y_arrow <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='va'>points</span><span class='op'>$</span><span class='va'>y</span>, <span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span>, <span class='cn'>NA</span><span class='op'>)</span>,</span>
<span>      point <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_points</span>,</span>
<span>      position <span class='op'>=</span> <span class='fl'>1</span> <span class='op'>-</span> <span class='va'>positions</span><span class='op'>^</span><span class='fl'>1.3</span>,</span>
<span>      size_scale <span class='op'>=</span> <span class='va'>size_scaling</span>,</span>
<span>      Total_Value <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/nth.html'>first</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>$</span><span class='va'>Total_Value</span><span class='op'>)</span></span>
<span>    <span class='op'>)</span></span>
<span>  <span class='op'>}</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h4 id="adjusting-flow-sizes">Adjusting flow sizes</h4>
<p>The size scaling formula works well for most trade flows. But the biggest flows
need special care.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># define manual size adjustments for major trade routes</span></span>
<span><span class='va'>manual_adjustments</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>  Exporter <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Canada"</span>, <span class='st'>"UAE"</span>, <span class='st'>"Australia"</span>, <span class='st'>"Russia"</span>, <span class='st'>"Areas, nes"</span>, </span>
<span>               <span class='st'>"Brazil"</span>, <span class='st'>"USA"</span>, <span class='st'>"Norway"</span>, <span class='st'>"USA"</span><span class='op'>)</span>,</span>
<span>  Importer <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"USA"</span>, <span class='st'>"Areas, nes"</span>, <span class='st'>"China"</span>, <span class='st'>"China"</span>, <span class='st'>"Germany"</span>, </span>
<span>               <span class='st'>"China"</span>, <span class='st'>"Mexico"</span>, <span class='st'>"Germany"</span>, <span class='st'>"China"</span><span class='op'>)</span>,</span>
<span>  manual_size <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>12</span>, <span class='fl'>8</span>, <span class='fl'>5.5</span>, <span class='fl'>3.75</span>, <span class='fl'>2.25</span>, <span class='fl'>3.5</span>, <span class='fl'>2.85</span>, <span class='fl'>2.5</span>, <span class='fl'>2.5</span><span class='op'>)</span> <span class='op'>/</span> <span class='fl'>1.75</span><span class='op'>)</span> </span>
<span></span>
<span><span class='co'># apply manual sizes</span></span>
<span><span class='va'>trade_flows_with_points</span> <span class='op'>&lt;-</span> <span class='va'>trade_flows_with_points</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>manual_size <span class='op'>=</span> <span class='cn'>NA_real_</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rows.html'>rows_update</a></span><span class='op'>(</span><span class='va'>manual_adjustments</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Exporter"</span>, <span class='st'>"Importer"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>Exporter</span>, <span class='va'>Importer</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    size_scale <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/if_else.html'>if_else</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>manual_size</span><span class='op'>)</span>,</span>
<span>                         <span class='va'>manual_size</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>size_scale</span> <span class='op'>/</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>size_scale</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>                         <span class='va'>size_scale</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h4 id="get-the-colors">Get the colors</h4>
<p>The original plot uses a continuous color scale to color the trade flows as they
progress from the exporting country (pinkish) to the importing country (blueish).
We use eight different colors to approximate the continuous scale as well as
possible, again using <a href="https://imagecolorpicker.com/">imagecolorpicker</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>flow_colors</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/grDevices/colorRamp.html'>colorRampPalette</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>  <span class='st'>"#01a9e9"</span>, <span class='st'>"#3894D3"</span>, <span class='st'>"#6188CB"</span>, <span class='st'>"#8581ca"</span>,</span>
<span>  <span class='st'>"#AA70BC"</span>, <span class='st'>"#C662B0"</span>, <span class='st'>"#e43998"</span>, <span class='st'>"#D84CA5"</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<h4 id="putting-it-all-together">Putting it all together</h4>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># add the trade flows to our map</span></span>
<span><span class='va'>p</span> <span class='op'>&lt;-</span> <span class='va'>p</span> <span class='op'>+</span></span>
<span>  <span class='co'># full bezier curves with gradient</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_path</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>trade_flows_with_points</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x_full</span>, y <span class='op'>=</span> <span class='va'>y_full</span>, </span>
<span>                group <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/interaction.html'>interaction</a></span><span class='op'>(</span><span class='va'>Exporter</span>, <span class='va'>Importer</span><span class='op'>)</span>,</span>
<span>                size <span class='op'>=</span> <span class='va'>size_scale</span>,</span>
<span>                color <span class='op'>=</span> <span class='va'>position</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='co'># add custom color scale</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_gradient.html'>scale_color_gradientn</a></span><span class='op'>(</span></span>
<span>    colours <span class='op'>=</span> <span class='fu'>flow_colors</span><span class='op'>(</span><span class='fl'>500</span><span class='op'>)</span>,</span>
<span>    guide <span class='op'>=</span> <span class='st'>"none"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_identity.html'>scale_size_identity</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  <span class='co'># add arrows</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_path</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>trade_flows_with_points</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x_arrow</span>, y <span class='op'>=</span> <span class='va'>y_arrow</span>, </span>
<span>                group <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/interaction.html'>interaction</a></span><span class='op'>(</span><span class='va'>Exporter</span>, <span class='va'>Importer</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>0.12</span>, </span>
<span>            arrow <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grid/arrow.html'>arrow</a></span><span class='op'>(</span>length <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/grid/unit.html'>unit</a></span><span class='op'>(</span><span class='fl'>0.10</span>, <span class='st'>"cm"</span><span class='op'>)</span>, </span>
<span>                         type <span class='op'>=</span> <span class='st'>"closed"</span>,</span>
<span>                         ends <span class='op'>=</span> <span class='st'>"last"</span><span class='op'>)</span>,</span>
<span>            color <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>            alpha <span class='op'>=</span> <span class='fl'>.7</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># now we need to add the labels and boxes for the nes areas again because we </span></span>
<span><span class='co'># want the labels and boxes to be on top of the flows</span></span>
<span><span class='va'>p</span> <span class='op'>&lt;-</span> <span class='va'>p</span> <span class='op'>+</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span> <span class='op'>-</span> <span class='fl'>0.1</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.75</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            <span class='co'># we need to adjust the lineheight argument for "Korea, \nRep." and </span></span>
<span>            <span class='co'># "Saudi \n Arabia" to make sure that the vertical spacing is fine</span></span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span> <span class='op'>+</span> <span class='fl'>0.1</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.75</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span> <span class='op'>-</span> <span class='fl'>0.1</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.75</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span> <span class='op'>+</span> <span class='fl'>0.1</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.75</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  </span>
<span>  <span class='co'># add country labels (white)</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.77</span>,  <span class='co'># slightly larger than the black text</span></span>
<span>            color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  </span>
<span>  <span class='co'># add country labels (black)</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>country_labels_adj</span>,</span>
<span>            <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>long</span>, y <span class='op'>=</span> <span class='va'>lat</span>, label <span class='op'>=</span> <span class='va'>Label</span><span class='op'>)</span>,</span>
<span>            size <span class='op'>=</span> <span class='fl'>1.65</span>,  </span>
<span>            color <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>            fontface <span class='op'>=</span> <span class='st'>"bold"</span>,</span>
<span>            lineheight <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  </span>
<span>  <span class='co'># add rectangles for nes areas</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_tile.html'>geom_rect</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>    xmin <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>11.75</span>, </span>
<span>             <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>2</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>22.5</span><span class='op'>)</span>,</span>
<span>    xmax <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>]</span>  <span class='op'>+</span> <span class='fl'>11.75</span>, </span>
<span>             <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>2</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>22.5</span><span class='op'>)</span>,</span>
<span>    ymin <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>2.6</span>, </span>
<span>             <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>3</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>2.6</span><span class='op'>)</span>,</span>
<span>    ymax <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>2.6</span>, </span>
<span>             <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>3</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>2.6</span><span class='op'>)</span>,</span>
<span>    label <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Areas, nes"</span>, <span class='st'>"Rest of America, nes"</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>xmin <span class='op'>=</span> <span class='va'>xmin</span>, xmax <span class='op'>=</span> <span class='va'>xmax</span>, ymin <span class='op'>=</span> <span class='va'>ymin</span>, ymax <span class='op'>=</span> <span class='va'>ymax</span><span class='op'>)</span>,</span>
<span>    fill <span class='op'>=</span> <span class='st'>"#ffffff"</span>,</span>
<span>    alpha <span class='op'>=</span> <span class='fl'>.9</span>,</span>
<span>    color <span class='op'>=</span> <span class='st'>"#cccccc"</span>, </span>
<span>    size <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  </span>
<span>  <span class='co'># add text labels for nes areas</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>]</span>, <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>,</span>
<span>    y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>3</span><span class='op'>]</span>, <span class='va'>special_areas_coords</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>3</span><span class='op'>]</span><span class='op'>)</span>,</span>
<span>    label <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Areas, nes"</span>, <span class='st'>"Rest of America, nes"</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span>, label <span class='op'>=</span> <span class='va'>label</span><span class='op'>)</span>,</span>
<span>    size <span class='op'>=</span> <span class='fl'>1.65</span>, </span>
<span>    fontface <span class='op'>=</span> <span class='st'>"bold"</span><span class='op'>)</span> <span class='op'>+</span> </span>
<span>  </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>text <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_text</a></span><span class='op'>(</span>family <span class='op'>=</span> <span class='st'>"gudea"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/unnamed-chunk-26-1.png" width="100%" data-distill-preview=1 style="display: block; margin: auto;" /></p>
</div>
<h2 id="alternative-visualisation">Alternative visualisation</h2>
<p>The original plot is visually appealing. It also effectively communicates the
key patterns in global commodities trade. First, China imports massive amounts
of commodities, reflecting its status as the world’s manufacturing powerhouse.
Second, the US trades commodities mainly with Canada and Mexico, leading to
relatively regional supply chains in North America. Third, intra-european trade
is strong. Fourth, the Middle East is a major player in commodities trade.</p>
<p>However, the original plot still faces some issues.
First, the plot becomes cluttered in high-density trading regions, particularly
around China and Europe. In these regions, trade flows overlap and arrows become
difficult to distinguish, potentially obscuring important patterns.
Second, the plot uses four visual channels (flows, arrows, colours and line
thickness) to represent the direction of trade flows. This is considered bad
practice as one data attribute should be mapped to one visual channel only.
Third, the plot focuses only on the 76 largest trade flows. If we wanted to add
more flows, the readability of the plot would worsen further. In other words,
the plot has limited scalability.</p>
<p>While the original plot offers interactivity features (e.g., highlighting
specific country’s trade flows when clicking on it) to address these issues
(especially the problem of clutter), we can explore network graphs as an
alternative approach. Networks offer the following advantages for visualising
this bilateral trade data. First, by freeing nodes from geographic constraints,
we can emphasize economic relationships and reveal true trading hubs, thereby
gaining deeper knowledge about the structural relationships in global trade.
Second, network graphs are more scalable. Force-directed layouts handle dense
connections much better by finding optimal node positions that minimise edge
crossings. In this way, we could relatively easily show hundreds of trade flows.
Third, network graphs can have higher information density. As we will see, we can
color the edges to encode additional information, e.g., continental clusters or
groupings.</p>
<p>We will explore two different network visualization approaches using
force-directed layouts: Fruchterman-Reingold and Kamada-Kawai algorithms.</p>
<h3 id="preliminaries-1">1. Preliminaries</h3>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># we go for the igraph package, even though there are plenty of other good</span></span>
<span><span class='co'># choices as well, e.g., ggnetwork or tidygraph</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://r.igraph.org/'>igraph</a></span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># create continent mapping: for the legend and the coloring of the nodes/ edges</span></span>
<span><span class='va'>continent_mapping</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span></span>
<span>  Europe <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"AUT"</span>, <span class='st'>"BEL"</span>, <span class='st'>"CHE"</span>, <span class='st'>"DEU"</span>, <span class='st'>"ESP"</span>, <span class='st'>"FRA"</span>, <span class='st'>"GBR"</span>, <span class='st'>"ITA"</span>, <span class='st'>"NLD"</span>, <span class='st'>"NOR"</span><span class='op'>)</span>,</span>
<span>  Asia <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"ARE"</span>, <span class='st'>"AZE"</span>, <span class='st'>"CHN"</span>, <span class='st'>"HKG"</span>, <span class='st'>"IDN"</span>, <span class='st'>"IND"</span>, <span class='st'>"IRQ"</span>, <span class='st'>"JPN"</span>, <span class='st'>"KOR"</span>, <span class='st'>"KWT"</span>, </span>
<span>           <span class='st'>"MYS"</span>, <span class='st'>"OMN"</span>, <span class='st'>"QAT"</span>, <span class='st'>"RUS"</span>, <span class='st'>"SAU"</span>, <span class='st'>"THA"</span>, <span class='st'>"TUR"</span><span class='op'>)</span>,</span>
<span>  Africa <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"AGO"</span>, <span class='st'>"DZA"</span>, <span class='st'>"ZAF"</span><span class='op'>)</span>,</span>
<span>  <span class='st'>"North America"</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"CAN"</span>, <span class='st'>"MEX"</span>, <span class='st'>"USA"</span><span class='op'>)</span>,</span>
<span>  <span class='st'>"South America"</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"BRA"</span>, <span class='st'>"CHL"</span>, <span class='st'>"PER"</span><span class='op'>)</span>,</span>
<span>  Australia <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"AUS"</span><span class='op'>)</span>,</span>
<span>  Other <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Nes"</span>, <span class='st'>"NesA"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># create color mapping for continents using IBM color-blind palette</span></span>
<span><span class='va'>continent_colors</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>  Europe <span class='op'>=</span> <span class='st'>"#648FFF"</span>,        <span class='co'># vivid blue</span></span>
<span>  Asia <span class='op'>=</span> <span class='st'>"#785EF0"</span>,         <span class='co'># purple</span></span>
<span>  Africa <span class='op'>=</span> <span class='st'>"#DC267F"</span>,       <span class='co'># magenta</span></span>
<span>  <span class='st'>"North America"</span> <span class='op'>=</span> <span class='st'>"#FE6100"</span>, <span class='co'># orange</span></span>
<span>  <span class='st'>"South America"</span> <span class='op'>=</span> <span class='st'>"#FFB000"</span>, <span class='co'># gold</span></span>
<span>  Australia <span class='op'>=</span> <span class='st'>"#24A608"</span>,    <span class='co'># green</span></span>
<span>  Other <span class='op'>=</span> <span class='st'>"#B4B4B4"</span><span class='op'>)</span>         <span class='co'># gray</span></span></code></pre>
</div>
</div>
<h3 id="network-graphs">2. Network graphs</h3>
<h4 id="fruchterman-reingold">Fruchterman-Reingold</h4>
<p>The <a href="https://cs.brown.edu/people/rtamassi/gdhandbook/chapters/force-directed.pdf">Fruchterman-Reingold algorithm</a>
simulates a physical system where the nodes push each other away, while the
edges pull or attract connected nodes like springs. This algorithm helps us to
identify clusters or trading hubs.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># prepare the data</span></span>
<span><span class='va'>data_2_filtered_clean</span> <span class='op'>&lt;-</span> <span class='va'>data_2_filtered</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    Exporter_ISO3 <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span></span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>Exporter_ISO3</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='va'>Exporter</span> <span class='op'>==</span> <span class='st'>"Areas, nes"</span> <span class='op'>~</span> <span class='st'>"Nes"</span>,</span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>Exporter_ISO3</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='va'>Exporter</span> <span class='op'>==</span> <span class='st'>"Rest of America, nes"</span> <span class='op'>~</span> <span class='st'>"NesA"</span>,</span>
<span>      <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='va'>Exporter_ISO3</span></span>
<span>    <span class='op'>)</span>,</span>
<span>    Importer_ISO3 <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span></span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>Importer_ISO3</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='va'>Importer</span> <span class='op'>==</span> <span class='st'>"Areas, nes"</span> <span class='op'>~</span> <span class='st'>"Nes"</span>,</span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>Importer_ISO3</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='va'>Importer</span> <span class='op'>==</span> <span class='st'>"Rest of America, nes"</span> <span class='op'>~</span> <span class='st'>"NesA"</span>,</span>
<span>      <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='va'>Importer_ISO3</span></span>
<span>    <span class='op'>)</span></span>
<span>  <span class='op'>)</span></span>
<span></span>
<span><span class='co'># create edge list with weights</span></span>
<span><span class='va'>edges</span> <span class='op'>&lt;-</span> <span class='va'>data_2_filtered_clean</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>Exporter_ISO3</span>, <span class='va'>Importer_ISO3</span>, <span class='va'>Total_Value</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>from <span class='op'>=</span> <span class='va'>Exporter_ISO3</span>, to <span class='op'>=</span> <span class='va'>Importer_ISO3</span>, weight <span class='op'>=</span> <span class='va'>Total_Value</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># create unique node list and graph</span></span>
<span><span class='va'>nodes</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>edges</span><span class='op'>$</span><span class='va'>from</span>, <span class='va'>edges</span><span class='op'>$</span><span class='va'>to</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>g</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r.igraph.org/reference/graph_from_data_frame.html'>graph_from_data_frame</a></span><span class='op'>(</span>d <span class='op'>=</span> <span class='va'>edges</span>, vertices <span class='op'>=</span> <span class='va'>nodes</span>, directed <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># calculate node strength and assign properties</span></span>
<span><span class='va'>node_strength</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r.igraph.org/reference/strength.html'>strength</a></span><span class='op'>(</span><span class='va'>g</span>, mode <span class='op'>=</span> <span class='st'>"total"</span>, weights <span class='op'>=</span> <span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>weight</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>continent</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>name</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='kw'>for</span><span class='op'>(</span><span class='va'>cont</span> <span class='kw'>in</span> <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>continent_mapping</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='kw'>if</span><span class='op'>(</span><span class='va'>x</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='va'>continent_mapping</span><span class='op'>[[</span><span class='va'>cont</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span> <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>cont</span><span class='op'>)</span></span>
<span>  <span class='op'>}</span></span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='st'>"Other"</span><span class='op'>)</span></span>
<span><span class='op'>}</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>color</span> <span class='op'>&lt;-</span> <span class='va'>continent_colors</span><span class='op'>[</span><span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>continent</span><span class='op'>]</span></span>
<span></span>
<span><span class='co'># assign edge colors based on source continent with alpha</span></span>
<span><span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>color</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>e</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='va'>source_node</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>[</span><span class='fu'><a href='https://r.igraph.org/reference/ends.html'>ends</a></span><span class='op'>(</span><span class='va'>g</span>, <span class='va'>e</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/grDevices/rgb.html'>rgb</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/grDevices/col2rgb.html'>col2rgb</a></span><span class='op'>(</span><span class='va'>continent_colors</span><span class='op'>[</span><span class='va'>source_node</span><span class='op'>$</span><span class='va'>continent</span><span class='op'>]</span><span class='op'>)</span><span class='op'>/</span><span class='fl'>255</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.4</span><span class='op'>)</span></span>
<span><span class='op'>}</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># set node sizes and edge widths</span></span>
<span><span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>size</span> <span class='op'>&lt;-</span> <span class='fl'>10</span> <span class='op'>+</span> <span class='fl'>20</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>node_strength</span> <span class='op'>/</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>node_strength</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>width</span> <span class='op'>&lt;-</span> <span class='fl'>0.5</span> <span class='op'>+</span> <span class='fl'>24</span> <span class='op'>*</span> <span class='op'>(</span><span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>weight</span> <span class='op'>/</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>weight</span><span class='op'>)</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>0.8</span></span>
<span></span>
<span><span class='co'># create basic layout</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>42</span><span class='op'>)</span></span>
<span><span class='va'>layout_fr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r.igraph.org/reference/layout_with_fr.html'>layout_with_fr</a></span><span class='op'>(</span><span class='va'>g</span>, niter <span class='op'>=</span> <span class='fl'>2500</span>, weights <span class='op'>=</span> <span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>weight</span><span class='op'>^</span><span class='fl'>0.5</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># normalize the layout</span></span>
<span><span class='va'>layout_normalized</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/apply.html'>apply</a></span><span class='op'>(</span><span class='va'>layout_fr</span>, <span class='fl'>2</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='op'>(</span><span class='va'>x</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>/</span> <span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>2</span> <span class='op'>-</span> <span class='fl'>1</span></span>
<span><span class='op'>}</span><span class='op'>)</span></span>
<span><span class='va'>layout_final</span> <span class='op'>&lt;-</span> <span class='va'>layout_normalized</span> <span class='op'>*</span> <span class='fl'>5</span></span>
<span></span>
<span><span class='co'># plot</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>bg <span class='op'>=</span> <span class='st'>"white"</span>, mar <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.1</span>, <span class='fl'>0.1</span>, <span class='fl'>2</span>, <span class='fl'>12</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>g</span>, </span>
<span>     layout <span class='op'>=</span> <span class='va'>layout_final</span>,</span>
<span>     vertex.label <span class='op'>=</span> <span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>name</span>,</span>
<span>     vertex.label.color <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>     vertex.label.cex <span class='op'>=</span> <span class='fl'>1.3</span>,</span>
<span>     vertex.label.font <span class='op'>=</span> <span class='fl'>2</span>,</span>
<span>     vertex.frame.color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>     edge.arrow.size <span class='op'>=</span> <span class='fl'>0.15</span>,</span>
<span>     edge.curved <span class='op'>=</span> <span class='fl'>0.15</span>,</span>
<span>     asp <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/title.html'>title</a></span><span class='op'>(</span><span class='st'>"Alternative visualisation - Fruchterman-Reingold"</span>, line <span class='op'>=</span> <span class='fl'>0</span>, cex.main <span class='op'>=</span> <span class='fl'>2.25</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/legend.html'>legend</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"bottom"</span>, </span>
<span>       title <span class='op'>=</span> <span class='st'>""</span>,</span>
<span>       legend <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>continent_colors</span><span class='op'>)</span>,</span>
<span>       fill <span class='op'>=</span> <span class='va'>continent_colors</span>,</span>
<span>       cex <span class='op'>=</span> <span class='fl'>1.2</span>,</span>
<span>       bty <span class='op'>=</span> <span class='st'>"n"</span>,</span>
<span>       xpd <span class='op'>=</span> <span class='cn'>TRUE</span>,</span>
<span>       horiz <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/network_plot_1-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<p>We can see that there is quite a few nodes overlapping, especially around the
key trading hubs China and the US. This complicates readability. We can apply
jitter and use manual adjustments to re-position the nodes. We make sure that we
are strict and systematic in shifting the nodes: they are shifted as little as
possible and the shifts are either diagonal or to the left, right, bottom or top.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># add jitter to layout</span></span>
<span><span class='va'>jitter_amount</span> <span class='op'>&lt;-</span> <span class='fl'>0.05</span></span>
<span><span class='va'>layout_with_jitter</span> <span class='op'>&lt;-</span> <span class='va'>layout_fr</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>layout_fr</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>2</span>, </span>
<span>                                              <span class='op'>-</span><span class='va'>jitter_amount</span>, <span class='va'>jitter_amount</span><span class='op'>)</span>, </span>
<span>                                        ncol <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># normalize with jitter</span></span>
<span><span class='va'>layout_normalized</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/apply.html'>apply</a></span><span class='op'>(</span><span class='va'>layout_with_jitter</span>, <span class='fl'>2</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='op'>(</span><span class='va'>x</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>/</span> <span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>2</span> <span class='op'>-</span> <span class='fl'>1</span></span>
<span><span class='op'>}</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>layout_final</span> <span class='op'>&lt;-</span> <span class='va'>layout_normalized</span> <span class='op'>*</span> <span class='fl'>5</span></span>
<span></span>
<span><span class='co'># manual Node adjustment: define adjustment rules for major trade hubs</span></span>
<span><span class='va'>node_adjustment_rules</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span></span>
<span>  <span class='co'># European cluster</span></span>
<span>  europe_cluster <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span></span>
<span>    nodes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"ITA"</span>, <span class='st'>"GBR"</span><span class='op'>)</span>,</span>
<span>    adjustments <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>      node <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"ITA"</span>, <span class='st'>"GBR"</span><span class='op'>)</span>,</span>
<span>      x_shift <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.2</span>, <span class='fl'>0.2</span><span class='op'>)</span>,    <span class='co'># spread horizontally</span></span>
<span>      y_shift <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>0.2</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,    <span class='co'># spread vertically</span></span>
<span>  </span>
<span>  <span class='co'># Asian cluster around China</span></span>
<span>  asia_cluster <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span></span>
<span>    nodes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"HKG"</span>, <span class='st'>"IRQ"</span>, <span class='st'>"MYS"</span><span class='op'>)</span>,</span>
<span>    adjustments <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>      node <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"HKG"</span>, <span class='st'>"IRQ"</span>, <span class='st'>"MYS"</span><span class='op'>)</span>,</span>
<span>      x_shift <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='op'>-</span><span class='fl'>0.2</span>, <span class='fl'>0.2</span><span class='op'>)</span>, <span class='co'># spread horizontally</span></span>
<span>      y_shift <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.3</span>, <span class='op'>-</span><span class='fl'>0.2</span>, <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>, <span class='co'># spread vertically</span></span>
<span>  </span>
<span>  <span class='co'># North America cluster</span></span>
<span>  na_cluster <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span></span>
<span>    nodes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"CAN"</span>, <span class='st'>"USA"</span>, <span class='st'>"KOR"</span>, <span class='st'>"RUS"</span>, <span class='st'>"ARE"</span><span class='op'>)</span>,</span>
<span>    adjustments <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>      node <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"CAN"</span>, <span class='st'>"USA"</span>, <span class='st'>"KOR"</span>, <span class='st'>"RUS"</span>, <span class='st'>"ARE"</span><span class='op'>)</span>,</span>
<span>      x_shift <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>0.25</span>, <span class='fl'>0</span>, <span class='fl'>0.2</span>, <span class='fl'>0.3</span>, <span class='fl'>0.4</span><span class='op'>)</span>, <span class='co'># spread horizontally</span></span>
<span>      y_shift <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.25</span>, <span class='op'>-</span><span class='fl'>0.4</span>, <span class='fl'>0.2</span>, <span class='op'>-</span><span class='fl'>0.3</span>, <span class='fl'>0.4</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>, <span class='co'># spread vertically</span></span>
<span>  </span>
<span>  <span class='co'># other cluster</span></span>
<span>  other_cluster <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span></span>
<span>    nodes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"MEX"</span><span class='op'>)</span>,</span>
<span>    adjustments <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>      node <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"MEX"</span><span class='op'>)</span>,</span>
<span>      x_shift <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>0.35</span><span class='op'>)</span>, <span class='co'># spread horizontally</span></span>
<span>      y_shift <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>0.35</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='co'># spread vertically</span></span>
<span></span>
<span><span class='co'># custom function to apply adjustments</span></span>
<span><span class='va'>apply_node_adjustments</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>layout</span>, <span class='va'>node_indices</span>, <span class='va'>adjustment_rules</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='va'>adjusted_layout</span> <span class='op'>&lt;-</span> <span class='va'>layout</span></span>
<span>  </span>
<span>  <span class='co'># record all adjustments for documentation</span></span>
<span>  <span class='va'>adjustment_log</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>    node <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/character.html'>character</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    original_x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>numeric</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    original_y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>numeric</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    adjustment_x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>numeric</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    adjustment_y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>numeric</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    rule_applied <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/character.html'>character</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>    stringsAsFactors <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span></span>
<span>  </span>
<span>  <span class='co'># apply each rule set</span></span>
<span>  <span class='kw'>for</span><span class='op'>(</span><span class='va'>cluster_name</span> <span class='kw'>in</span> <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>adjustment_rules</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='va'>rule_set</span> <span class='op'>&lt;-</span> <span class='va'>adjustment_rules</span><span class='op'>[[</span><span class='va'>cluster_name</span><span class='op'>]</span><span class='op'>]</span></span>
<span>    </span>
<span>    <span class='kw'>for</span><span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>rule_set</span><span class='op'>$</span><span class='va'>adjustments</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>      <span class='va'>node</span> <span class='op'>&lt;-</span> <span class='va'>rule_set</span><span class='op'>$</span><span class='va'>adjustments</span><span class='op'>$</span><span class='va'>node</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span></span>
<span>      <span class='kw'>if</span><span class='op'>(</span><span class='va'>node</span> <span class='op'><a href='https://rdrr.io/r/base/match.html'>%in%</a></span> <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>node_indices</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>        <span class='va'>idx</span> <span class='op'>&lt;-</span> <span class='va'>node_indices</span><span class='op'>[</span><span class='va'>node</span><span class='op'>]</span></span>
<span>        </span>
<span>        <span class='co'># record original position</span></span>
<span>        <span class='va'>orig_pos</span> <span class='op'>&lt;-</span> <span class='va'>adjusted_layout</span><span class='op'>[</span><span class='va'>idx</span>, <span class='op'>]</span></span>
<span>        </span>
<span>        <span class='co'># apply adjustment</span></span>
<span>        <span class='va'>adjusted_layout</span><span class='op'>[</span><span class='va'>idx</span>, <span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>adjusted_layout</span><span class='op'>[</span><span class='va'>idx</span>, <span class='op'>]</span> <span class='op'>+</span> </span>
<span>          <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>rule_set</span><span class='op'>$</span><span class='va'>adjustments</span><span class='op'>$</span><span class='va'>x_shift</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span>, </span>
<span>            <span class='va'>rule_set</span><span class='op'>$</span><span class='va'>adjustments</span><span class='op'>$</span><span class='va'>y_shift</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>)</span></span>
<span>        </span>
<span>        <span class='co'># log the adjustment</span></span>
<span>        <span class='va'>adjustment_log</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>adjustment_log</span>, <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span></span>
<span>          node <span class='op'>=</span> <span class='va'>node</span>,</span>
<span>          original_x <span class='op'>=</span> <span class='va'>orig_pos</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>,</span>
<span>          original_y <span class='op'>=</span> <span class='va'>orig_pos</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span>,</span>
<span>          adjustment_x <span class='op'>=</span> <span class='va'>rule_set</span><span class='op'>$</span><span class='va'>adjustments</span><span class='op'>$</span><span class='va'>x_shift</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span>,</span>
<span>          adjustment_y <span class='op'>=</span> <span class='va'>rule_set</span><span class='op'>$</span><span class='va'>adjustments</span><span class='op'>$</span><span class='va'>y_shift</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span>,</span>
<span>          rule_applied <span class='op'>=</span> <span class='va'>cluster_name</span></span>
<span>        <span class='op'>)</span><span class='op'>)</span></span>
<span>      <span class='op'>}</span></span>
<span>    <span class='op'>}</span></span>
<span>  <span class='op'>}</span></span>
<span>  </span>
<span>  <span class='co'># return both adjusted layout and log</span></span>
<span>  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span></span>
<span>    layout <span class='op'>=</span> <span class='va'>adjusted_layout</span>,</span>
<span>    log <span class='op'>=</span> <span class='va'>adjustment_log</span></span>
<span>  <span class='op'>)</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span>
<span></span>
<span><span class='co'># apply adjustments and get log</span></span>
<span><span class='va'>node_indices</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>)</span>, <span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>name</span><span class='op'>)</span></span>
<span><span class='va'>adjustment_result</span> <span class='op'>&lt;-</span> <span class='fu'>apply_node_adjustments</span><span class='op'>(</span><span class='va'>layout_final</span>, <span class='va'>node_indices</span>, <span class='va'>node_adjustment_rules</span><span class='op'>)</span></span>
<span><span class='va'>layout_final</span> <span class='op'>&lt;-</span> <span class='va'>adjustment_result</span><span class='op'>$</span><span class='va'>layout</span></span>
<span></span>
<span></span>
<span><span class='co'># create final plot with adjustments</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>bg <span class='op'>=</span> <span class='st'>"white"</span>, mar <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.1</span>, <span class='fl'>0.1</span>, <span class='fl'>2</span>, <span class='fl'>12</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>g</span>, </span>
<span>     layout <span class='op'>=</span> <span class='va'>layout_final</span>,</span>
<span>     vertex.label <span class='op'>=</span> <span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>name</span>,</span>
<span>     vertex.label.color <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>     vertex.label.cex <span class='op'>=</span> <span class='fl'>1.3</span>,</span>
<span>     vertex.label.font <span class='op'>=</span> <span class='fl'>2</span>,</span>
<span>     vertex.frame.color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>     edge.arrow.size <span class='op'>=</span> <span class='fl'>0.15</span>,</span>
<span>     edge.curved <span class='op'>=</span> <span class='fl'>0.15</span>,</span>
<span>     asp <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/title.html'>title</a></span><span class='op'>(</span><span class='st'>"Alternative visualisation - Fruchterman-Reingold (improved)"</span>, line <span class='op'>=</span> <span class='fl'>0</span>, cex.main <span class='op'>=</span> <span class='fl'>2.25</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/legend.html'>legend</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"bottom"</span>, </span>
<span>       title <span class='op'>=</span> <span class='st'>""</span>,</span>
<span>       legend <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>continent_colors</span><span class='op'>)</span>,</span>
<span>       fill <span class='op'>=</span> <span class='va'>continent_colors</span>,</span>
<span>       cex <span class='op'>=</span> <span class='fl'>1.2</span>,</span>
<span>       bty <span class='op'>=</span> <span class='st'>"n"</span>,</span>
<span>       xpd <span class='op'>=</span> <span class='cn'>TRUE</span>,</span>
<span>       horiz <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/network_plot_2-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<p>This network graph is more readable now. We can see the two key trading hubs
China and the US. The network also confirms strong intra-european trade.
Moreover, this network also indicates the strong economic ties African and South
American countries have with China.</p>
<h4 id="kamada-kawai">Kamada-Kawai</h4>
<p>Alternatively, we can use the <a href="https://cs.brown.edu/people/rtamassi/gdhandbook/chapters/force-directed.pdf">Kamada-Kawai algorithm</a>.
This algorithm attempts to match the visual distances between nodes to their
actual network distances (how many “hops” it takes to get from one node to
another). It also uses a spring system where nodes that are too close or too far
from each other compared to their network distance push apart or pull together.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># start with the new layout</span></span>
<span><span class='va'>layout_kk</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r.igraph.org/reference/layout_with_kk.html'>layout_with_kk</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># assign edge colors based on source (exporter) continent</span></span>
<span><span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>color</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>e</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='va'>source_node</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>[</span><span class='fu'><a href='https://r.igraph.org/reference/ends.html'>ends</a></span><span class='op'>(</span><span class='va'>g</span>, <span class='va'>e</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span></span>
<span>  <span class='va'>continent_colors</span><span class='op'>[</span><span class='va'>source_node</span><span class='op'>$</span><span class='va'>continent</span><span class='op'>]</span></span>
<span><span class='op'>}</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># add alpha to edge colors for better visibility</span></span>
<span><span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>color</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://r.igraph.org/reference/E.html'>E</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>color</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/grDevices/rgb.html'>rgb</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/grDevices/col2rgb.html'>col2rgb</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>/</span><span class='fl'>255</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.4</span><span class='op'>)</span></span>
<span><span class='op'>}</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># adjust node sizes to make them smaller if necessary</span></span>
<span><span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>size</span> <span class='op'>&lt;-</span> <span class='fl'>10</span> <span class='op'>+</span> <span class='fl'>12</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>node_strength</span> <span class='op'>/</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>node_strength</span><span class='op'>)</span><span class='op'>)</span> </span>
<span></span>
<span><span class='co'># set up the plot</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>bg <span class='op'>=</span> <span class='st'>"white"</span>, mar <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.1</span>, <span class='fl'>0.1</span>, <span class='fl'>2</span>, <span class='fl'>8</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>g</span>, </span>
<span>     layout <span class='op'>=</span> <span class='va'>layout_kk</span>,</span>
<span>     vertex.label <span class='op'>=</span> <span class='fu'><a href='https://r.igraph.org/reference/V.html'>V</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span><span class='op'>$</span><span class='va'>name</span>,</span>
<span>     vertex.label.color <span class='op'>=</span> <span class='st'>"black"</span>,</span>
<span>     vertex.label.cex <span class='op'>=</span> <span class='fl'>1.3</span>,</span>
<span>     vertex.label.font <span class='op'>=</span> <span class='fl'>2</span>,  <span class='co'># Added bold font</span></span>
<span>     vertex.frame.color <span class='op'>=</span> <span class='st'>"white"</span>,</span>
<span>     edge.arrow.size <span class='op'>=</span> <span class='fl'>0.15</span>,</span>
<span>     edge.curved <span class='op'>=</span> <span class='fl'>0.15</span>,</span>
<span>     asp <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>  <span class='co'># Removed edge.color as it's now set explicitly</span></span>
<span></span>
<span><span class='co'># add title</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/title.html'>title</a></span><span class='op'>(</span><span class='st'>"Alternative visualisation - Kamada-Kawai"</span>, </span>
<span>      line <span class='op'>=</span> <span class='fl'>0</span>, cex.main <span class='op'>=</span> <span class='fl'>2.25</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># add the same legend, again at the bottom</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/graphics/legend.html'>legend</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"bottom"</span>,  </span>
<span>       title <span class='op'>=</span> <span class='st'>""</span>,</span>
<span>       legend <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>continent_colors</span><span class='op'>)</span>,</span>
<span>       fill <span class='op'>=</span> <span class='va'>continent_colors</span>,</span>
<span>       cex <span class='op'>=</span> <span class='fl'>1.2</span>,  </span>
<span>       bty <span class='op'>=</span> <span class='st'>"n"</span>,</span>
<span>       xpd <span class='op'>=</span> <span class='cn'>TRUE</span>,</span>
<span>       horiz <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>  </span></code></pre>
</div>
<p><img src="100540594_files/figure-html5/network_plot_3-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<p>This algorithm makes it even easier to identify the core-periphery structure
that is defining global trade in commodities, with major economies like China
and the US forming the core and smaller economies like Austria, Thailand or
Azerbaijan being part of the periphery.</p>
<p>Overall, these networks are better than maps in handling bilateral trade data.
This is primarily because networks have (1) better scalability and (2) higher
information density.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="reuse">Reuse</h3>
  <p>Text and figures are licensed under Creative Commons Attribution <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. The figures that have been reused from other sources don't fall under this license and can be recognized by a note in their caption: "Figure from ...".</p>
  <h3 id="citation">Citation</h3>
  <p>For attribution, please cite this work as</p>
  <pre class="citation-appendix short">Struckmeyer (2025, Jan. 10). Data visualization | MSc CSS: Global trade flows in 2022. Retrieved from https://csslab.uc3m.es/dataviz/projects/2024/100540594/</pre>
  <p>BibTeX citation</p>
  <pre class="citation-appendix long">@misc{struckmeyer2025global,
  author = {Struckmeyer, Marvin-Julian},
  title = {Data visualization | MSc CSS: Global trade flows in 2022},
  url = {https://csslab.uc3m.es/dataviz/projects/2024/100540594/},
  year = {2025}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<!--radix_placeholder_navigation_after_body--><html><body>
<div class="distill-site-nav distill-site-footer">
<p><img src="../../../assets/acronimo_nombre1l_0.png" width="400"></p>
</div>
<!--/radix_placeholder_navigation_after_body-->
</body></html>


</body>

</html>
